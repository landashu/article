---
title: Linux 服务器整改条目
date: 2023-06-25 09:22:36
permalink:  /linux/2306
sidebar: true
article: false #  是否未非文章页，非文章不显示 面包屑和作者、时间，不显示最近更新栏，不会参与到最近更新文章的数据计算中
comment: false #  评论区
editLink: false
---


# 目标主机 showmount -e信息泄露
showmount -e 是一个用于查询 NFS（网络文件系统）服务器共享目录的命令。当目标主机启用 NFS 服务且配置不当时，攻击者可通过该命令直接获取服务器导出的目录结构（如 /data, /home 等），甚至绕过访问控制直接挂载敏感目录，导致数据泄露或未授权访问。例如：
* 信息泄露：攻击者通过 showmount -e <目标IP> 可列出所有共享目录，推测服务器功能（如数据库备份目录、用户数据目录）。
* 直接攻击：若 NFS 未限制客户端 IP，攻击者可通过 mount -t nfs <目标IP>:/敏感目录 /mnt 直接挂载并读取 / 写入数据。

**解决方案：**
1. 立即阻断 showmount -e 的访问
* 通过防火墙限制 NFS 端口访问，NFS 服务依赖端口 2049（NFS 主端口）和 111（rpcbind 端口），需仅允许可信 IP 访问：
  ```shell
  # 允许192.168.1.0/24网段访问NFS服务
  firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="2049" accept'
  firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="udp" port="2049" accept'
  firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="111" accept'
  firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="udp" port="111" accept'
  firewall-cmd --reload
  ```
  验证：执行 showmount -e <目标IP>，非授权 IP 应显示 clnt_create: RPC: Program not registered。
* 使用 hosts.allow/deny 限制 mountd 服务，修改 NFS 服务器的 /etc/hosts.allow 和 /etc/hosts.deny 文件：
  ```shell
  # 仅允许192.168.1.100访问mountd服务
  echo "mountd: 192.168.1.100" >> /etc/hosts.allow
  # 拒绝所有其他IP
  echo "mountd: ALL" >> /etc/hosts.deny
  ```
  生效方式：无需重启服务，立即生效。

2. 彻底修复 NFS 服务配置
* 编辑 NFS 服务器的 /etc/exports 文件，按以下原则配置：
  * 指定可信客户端：仅允许特定 IP 或网段访问。
  * 设置只读权限：非必要不开放写权限。
  * 启用 root_squash：将客户端 root 用户映射为匿名用户（nfsnobody）。
  ```shell
    # 示例：仅允许192.168.1.0/24网段只读访问/data目录，并限制root权限
    /data 192.168.1.0/24(ro,sync,root_squash)
  ```
  生效命令：exportfs -rv。
* 固定 NFS 动态端口并配置防火墙，NFS 的 LOCKD、MOUNTD 等服务默认使用随机端口，需固定端口并开放防火墙：
```shell
# 编辑/etc/sysconfig/nfs，添加以下内容
LOCKD_TCPPORT=32803
LOCKD_UDPPORT=32769
RQUOTAD_PORT=1001

# 开放固定端口
firewall-cmd --permanent --add-port=32803/tcp
firewall-cmd --permanent --add-port=32769/udp
firewall-cmd --permanent --add-port=1001/tcp
firewall-cmd --reload
```

# 目标主机支持RSA密钥交换
RSA 密钥交换是一种旧的加密方式，它不支持 “前向保密”。这意味着一旦服务器的私钥泄露，攻击者可以解密过去所有用该密钥加密的历史通信数据，存在严重的隐私和安全风险，现在已不推荐使用。而 ECDHE 等临时密钥交换算法，每次通信会生成临时密钥，即使私钥泄露，历史流量也无法被解密，更安全。

**解决方案：**
* 禁用 RSA 密钥交换算法：在服务器的 TLS 配置中，删除所有以RSA为密钥交换方式的加密套件（如RSA-AES256-GCM-SHA384等），打开 Nginx 的 SSL 配置文件（通常是nginx.conf），在server块的ssl_ciphers中，只保留以ECDHE开头的加密套件，删除所有RSA相关套件
```shell
server {
    listen 443 ssl;
    server_name example.com;
    
    # 禁用RSA密钥交换，只启用ECDHE
    ssl_protocols TLSv1.2 TLSv1.3;  # 禁用不安全的TLS版本
    ssl_prefer_server_ciphers on;
    # 只保留ECDHE相关加密套件，确保前向保密
    ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";
}
```
* 启用 ECDHE 临时密钥交换算法：优先配置并只保留以ECDHE为前缀的加密套件（如ECDHE-ECDSA-AES256-GCM-SHA384、ECDHE-RSA-AES128-GCM-SHA256等），确保通信时使用临时密钥交换。
* 重启服务生效：修改配置后，重启 Web 服务器（如 Nginx、Apache）或 TLS 相关服务，使新配置生效。
```shell
# 检查配置是否有误
nginx -t
# 重启Nginx生效
systemctl restart nginx
```

# SSH 服务支持弱加密算法
在配置远程SSH服务器时，出于安全性考虑，应避免使用诸如arcfour、aes128-cbc、blowfish-cbc、3des-cbc等弱加密算法。

**解决方案：**
打开 SSH 的主配置文件（通常是/etc/ssh/sshd_config），在文件中添加或修改以下配置，明确禁用弱算法，只保留安全的加密方式（如aes256-gcm@openssh.com、chacha20-poly1305@openssh.com等）
```shell
# 禁用弱加密算法，仅允许强算法
Ciphers aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
```
重启 SSH 服务使配置生效
```shell
Debian/Ubuntu：sudo systemctl restart sshd
CentOS/RHEL：sudo systemctl restart sshd
其他系统：sudo service sshd restart
```
用以下命令检查当前 SSH 服务器启用的加密算法，确认弱算法已被移除：
```shell
ssh -Q cipher localhost
```