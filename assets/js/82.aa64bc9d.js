(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{559:function(s,e,t){"use strict";t.r(e);var n=t(41),a=Object(n.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("最近公司要做一天 8 亿级数据的缓存，然后让我对 redis 进行一波性能测试，但是今天发现 redis 突然没有在运行，并且内存没有任何占用情况。然后我就想到先查看日志，如下")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("                _._                                                  \n           _.-``__ ''-._                                             \n      _.-``    `.  `_.  ''-._           Redis 6.0.8 (00000000/0) 64 bit\n  .-`` .-```.  ```\\/    _.,_ ''-._                                   \n (    '      ,       .-`  | `,    )     Running in standalone mode\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\n |    `-._   `._    /     _.-'    |     PID: 14135\n  `-._    `-._  `-./  _.-'    _.-'                                   \n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \n |    `-._`-._        _.-'_.-'    |           http://redis.io        \n  `-._    `-._`-.__.-'_.-'    _.-'                                   \n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \n |    `-._`-._        _.-'_.-'    |                                  \n  `-._    `-._`-.__.-'_.-'    _.-'                                   \n      `-._    `-.__.-'    _.-'                                       \n          `-._        _.-'                                           \n              `-.__.-'                                               \n\n14135:M 27 Sep 2020 20:36:47.498 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\n14135:M 27 Sep 2020 20:36:47.498 # Server initialized\n14135:M 27 Sep 2020 20:36:47.498 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\n14135:M 27 Sep 2020 20:36:47.498 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never').\n14135:M 27 Sep 2020 20:36:47.498 * Ready to accept connections\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("p",[s._v("日志除了启动信息以外并没有输出任何挂掉的信息。如果 redis 是被 cli 关掉的话，会在日志信息中有 bye bye 的信息，但日志没有，那就是可能是被 kill 的，通过如下命令可以查看情况。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@localhost log]# dmesg | egrep -i 'killed process'\n[ 1620.429506] Killed process 9696 (redis-server), UID 0, total-vm:23432912kB, anon-rss:18961524kB, file-rss:68kB, shmem-rss:0kB\n[338063.393365] Killed process 13956 (redis-server), UID 0, total-vm:33468100kB, anon-rss:26147740kB, file-rss:0kB, shmem-rss:0kB\n[367433.290406] Killed process 14135 (redis-server), UID 0, total-vm:39923260kB, anon-rss:34407376kB, file-rss:0kB, shmem-rss:0kB\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("发现 redis 的确是被 kill 掉的，我启动 redis 的进程是 14135，刚好查到 killed process 是有 14135。这台服务器只有我自己知道，所以可以直接排除是人为的情况。那程序被 kill 调就只有 linux 自己的策略了，我们知道 linux 是有 oom 的策略具体根据设置的 oom_score_adj 的值有关，那我们直接查下是不是 oom 原因杀死，命令如下")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('[root@localhost log]# grep "Out of memory" /var/log/messages  \nSep 27 16:45:11 localhost kernel: Out of memory: Kill process 13445 (redis-server) score 747 or sacrifice child\nSep 28 00:54:43 localhost kernel: Out of memory: Kill process 14135 (redis-server) score 951 or sacrifice child\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("看来真的是内存不够用把 redis 给 kill 了。如果是被其他用户 kill 掉的话我们该怎么排查？"),t("br"),s._v("\n先查询最近哪些用户登录")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@localhost log]# last\nroot     pts/3        192.168.200.89   Sun Sep 27 17:18   still logged in   \nroot     pts/1        192.168.200.89   Sun Sep 27 12:59   still logged in \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("table",[t("thead",[t("tr",[t("th",[s._v("符号")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("root")]),s._v(" "),t("td",[s._v("用户")])]),s._v(" "),t("tr",[t("td",[s._v("pts/3")]),s._v(" "),t("td",[s._v("终端")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.200.89")]),s._v(" "),t("td",[s._v("登录者 IP")])]),s._v(" "),t("tr",[t("td",[s._v("Sun Sep 27 17:18")]),s._v(" "),t("td",[s._v("登录时间")])]),s._v(" "),t("tr",[t("td",[s._v("still logged in （还在线）")]),s._v(" "),t("td",[s._v("登录状态 (距离上次登录时间)")])])])]),s._v(" "),t("p",[s._v("知道了以后也可以只查看某个用户，我这里只有 root 用户，实际情况中，每个人都应该有一个账户，root 只有超级管理员拥有，否则都用 root 用户是无法排查出来的。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@localhost log]# last root\nroot     pts/3        192.168.200.89   Sun Sep 27 17:18   still logged in   \nroot     pts/1        192.168.200.89   Sun Sep 27 12:59   still logged in   \nroot     pts/2        192.168.200.89   Sun Sep 27 09:47   still logged in   \nroot     pts/1        192.168.200.89   Sun Sep 27 09:46 - 12:59  (03:12)  \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("history 命令，可以把用户所用过的历史命令查出来，每个用户都会有这样一个文件。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("指令")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("-c")]),s._v(" "),t("td",[s._v("清空当前历史命令")])]),s._v(" "),t("tr",[t("td",[s._v("-a")]),s._v(" "),t("td",[s._v("将历史命令缓冲区中命令写入历史命令文件【/root/.bash_history】")])]),s._v(" "),t("tr",[t("td",[s._v("-r")]),s._v(" "),t("td",[s._v("将历史命令文件中的命令读入当前历史命令缓冲区")])]),s._v(" "),t("tr",[t("td",[s._v("-w")]),s._v(" "),t("td",[s._v("将当前历史命令缓冲区命令写入历史命令文件中【/root/.bash_history】")])]),s._v(" "),t("tr",[t("td",[s._v("n")]),s._v(" "),t("td",[s._v("如果 n=3 打印最近 3 条历史命令")])])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@localhost log]# history 10\n 1030  w rott\n 1031  w root\n 1032  history\n 1033  last\n 1034  last root\n 1035  w\n 1036  lastlog\n 1037  history\n 1038  history -h\n 1039  history 10\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("默认 history 不带执行时间，所以如果是同一个用户没办法区分是谁使用了 kill 造成破坏。"),t("br"),s._v("\n让 history 带有时间")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("echo 'export HISTTIMEFORMAT=\"%F %T  \"' >> /etc/bashrc\nsource /etc/bashrc\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@localhost log]# history 6\n 1048  2020-09-28 11:03:21  echo 'export HISTTIMEFORMAT=\"%F %T  \"' >> /etc/bashrc\n 1049  2020-09-28 11:03:25  source /etc/bashrc\n 1050  2020-09-28 11:03:27  history 10\n 1051  2020-09-28 11:04:27  ls\n 1052  2020-09-28 11:04:30  history 10\n 1053  2020-09-28 11:04:45  history 6\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])}),[],!1,null,null,null);e.default=a.exports}}]);