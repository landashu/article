(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{519:function(s,e,n){"use strict";n.r(e);var a=n(41),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("第七章中部署方案存在的问题：")]),s._v(" "),n("ol",[n("li",[s._v("一次只能选择一个微服务部署")]),s._v(" "),n("li",[s._v("只有一台生产者部署服务器")]),s._v(" "),n("li",[s._v("每个微服务只有一个实例，容错率低")])]),s._v(" "),n("p",[s._v("优化方案：")]),s._v(" "),n("ol",[n("li",[s._v("在一个 Jenkins 工程中可以选择多个微服务同时发布")]),s._v(" "),n("li",[s._v("在一个 Jenkins 工程中可以选择多台生产服务器同时部署")]),s._v(" "),n("li",[s._v("每个微服务都是以集群高可用形式部署")])]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"优化jenkins工程中可以选择多个微服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化jenkins工程中可以选择多个微服务"}},[s._v("#")]),s._v(" 优化 Jenkins 工程中可以选择多个微服务")]),s._v(" "),n("p",[s._v("安装 Extended Choice Parameter 插件，到项目配置中，可以看到选择参数多了一个选项")]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_1.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_2.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_3.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_4.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_5.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"优化jenkins工程中可以选择多台生产服务器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化jenkins工程中可以选择多台生产服务器"}},[s._v("#")]),s._v(" 优化 Jenkins 工程中可以选择多台生产服务器")]),s._v(" "),n("p",[s._v("1. 在 Manager Jenkins->Configure System->Publish over SSH-> 在添加服务器")]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_6.png",alt:""}})]),s._v(" "),n("p",[s._v("2. 在到项目配置中添加服务器选择，和工程中选择多个微服务是类似的")]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_7.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_8.png",alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/jenkins/507/img_9.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"脚本编写"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#脚本编写"}},[s._v("#")]),s._v(" 脚本编写")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 版本\ndef tag = "1.0"\n// 镜像仓库的地址\ndef harbor_url = "192.168.81.102:85"\n// 镜像仓库的项目,这里建议项目名称和jenkins的item项目名称、以及harbor的项目名称保持一致，否则用一下脚本会出问题\ndef harbor_project = "demo"\n\nnode {\n\n    // 获取当前选择的项目名称\n    def selectDProjectName = "${project_name}".split(",")\n    // 获取服务器列表\n    def selectDServers = "${publish_server}".split(",")\n\n    // 拉取代码\n    stage(\'pull code\') {\n        checkout([$class: \'GitSCM\', branches: [[name: \'*/${branch}\']], extensions: [], userRemoteConfigs: [[credentialsId: \'80dfe5c5-1684-47b1-a410-6f53ceb3c543\', url: \'http://192.168.81.15:3000/biguncle/test.git\']]])\n    }\n    // 编译并推送镜像仓库\n    stage(\'build project\') {\n\n        for(int i=0;i<selectDProjectName.length;i++){\n\n            def project = selectDProjectName[i].split("@")[0]\n            def port = selectDProjectName[i].split("@")[1]\n            // 编译\n            sh "mvn -f ${project} clean package dockerfile:build"\n            echo "把jar上传镜像仓库"\n            def oldImageName = "${project}:latest"\n            def newImageName = "${harbor_url}/${harbor_project}/${project}:${tag}"\n            // 改名称 做规范\n            sh "docker tag ${oldImageName} ${newImageName}"\n            // 删除之前的 镜像\n            sh "docker rmi ${oldImageName}"\n            // 推送到 dockers仓库\n            withCredentials([usernamePassword(credentialsId: \'8a3d7ab1-4cd6-482c-86c9-a12aa6404d98\', passwordVariable: \'harbor_password\', usernameVariable: \'harbor_account\')]) {\n                // 登录\n                sh "docker login -u ${harbor_account} -p ${harbor_password} ${harbor_url}"\n                // 上传\n                sh "docker push ${newImageName}"\n                echo "镜像推送成功"\n            }\n            for(int k=0;k<selectDServers.length;k++){\n                // 获取服务器名称\n                def currentServerName = selectDServers[k]\n                echo "执行远程命令 /home/server/deploy.sh ${harbor_url} ${harbor_project} ${project_name} ${tag} ${port}"\n                sshPublisher(publishers: [sshPublisherDesc(configName: "${currentServerName}", transfers: [sshTransfer(cleanRemote: false, excludes: \'\', execCommand: "/home/server/deploy.sh ${harbor_url} ${harbor_project} ${project_name} ${tag} ${port}", execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: \'[, ]+\', remoteDirectory: \'\', remoteDirectorySDF: false, removePrefix: \'\', sourceFiles: \'\')], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])\n\n            }\n        }\n    }\n}\n\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br")])])])}),[],!1,null,null,null);e.default=r.exports}}]);