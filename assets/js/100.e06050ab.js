(window.webpackJsonp=window.webpackJsonp||[]).push([[100],{578:function(s,a,n){"use strict";n.r(a);var t=n(41),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"账户与安全"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#账户与安全"}},[s._v("#")]),s._v(" 账户与安全")]),s._v(" "),n("h3",{attrs:{id:"用户创建和授权"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用户创建和授权"}},[s._v("#")]),s._v(" 用户创建和授权")]),s._v(" "),n("p",[s._v("MySQL8.0 创建用户和用户授权的命令需要分开执行：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建用户")]),s._v("\ncreate user "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" identified by "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'密码'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给用户授权")]),s._v("\ngrant all privileges on *.* to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("8.0 中默认的 user 表比 5.7 中多出一个 mysql.infoschema 用户，5.7 中可以使用一条语句及可以创建用户还可以授权")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 5.7 中的语句")]),s._v("\ngrant all privileges on *.* to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" identified by "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'密码'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"认证插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#认证插件"}},[s._v("#")]),s._v(" 认证插件")]),s._v(" "),n("p",[s._v("MySQL8.0 中默认的身份认证插件是  "),n("code",[s._v("caching_sha2_password")]),s._v(" ，替代了之前的  "),n("code",[s._v("mysql_native_password")]),s._v(" 。我们可以通过 default_authentication_plugin 系统变量，或者是数据库中 mysql.user 表可以看到这个变化。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用系统变量查看")]),s._v("\nshow variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'default_authentication%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用mysql.user表查看，这种可以看到每个所创建的用户用的是什么加密方式")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" user,host,plugin from mysql.user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("如果是旧版本的客户端在连接 MySQL8.0 可能会出现身份认证错误，即使你输入对的账号密码，如果想解决这个问题，可以升级客户端支持 MySQL8.0，或者修改 MySQL8.0 的身份认证方式。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改mysql自带的 /etc/my.cnf，添加如下，并重启")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("default_authentication_plugin")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql_native_password\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果不想重启，只想对某个用户做修改，可以使用如下方式")]),s._v("\nalter user "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" identified with mysql_native_password by "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'密码'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"密码管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#密码管理"}},[s._v("#")]),s._v(" 密码管理")]),s._v(" "),n("p",[s._v("MySQL8.0 开始允许限制重复使用以前的密码，也就是我们在修改密码的时候，要求我们不能修改为我们以前使用过的一些密码。变量如下：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新密码不能和最近3次使用过的密码相同，0不启用")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_history")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新密码不能喝最近90天内使用的密码相同，0不启用")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_reuse_interval")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改密码的时候需要提供用户的当前登录密码，off关闭")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_require_current")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ON\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("查看默认变量")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("show variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改变量的方式")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过修改 /etc/my.cnf 文件，并重启")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_history")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_reuse_interval")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_require_current")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ON\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置全局变量，这种方式只针对当前进程有效，服务器重启恢复之前")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_history")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql8.0新添加一种方式，这种方式不仅当前进程有效，并且服务器重启任然会生效")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" persist "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("password_history")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果只想更改某个用户的限制")]),s._v("\nalter user "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" password "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置完成后可以查看表是否多Password_reuse_history、Password_reuse_time、Password_reuse_current")]),s._v("\ndesc mysql.user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以上没有问题，我们可以查看该针对某个用户设置的值，如果全局有设置，则没设置的默认使用全局设置的")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" user,host,Password_reuse_history from mysql.user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("set persist 方式其实是新添加了一个配置文件 /var/lib/mysql/mysql-auto.cnf")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过该语句可以查看文件内容")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" /var/lib/mysql/mysql-auto.cnf \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("完成后设置后，我们可以通过修改密码来进行测试")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("alter user "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v("@"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" identified by "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'密码'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改密码的记录存在于 mysql.password_history 表中")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from mysql.password_history\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("password_require_current=ON 不受 root 用户进行管制，只限制非 root 用户修改的时候才生效。")])]),s._v(" "),n("p",[s._v("password_require_current=ON 非 root 用户修改密码的时候，会提示使用 REPLACE 关键字，整体修改密码语句如下")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user() 为当前 '账户'@'%'")]),s._v("\nalter user user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" identified by "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'新密码'")]),s._v(" replace "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'当前密码'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"角色管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#角色管理"}},[s._v("#")]),s._v(" 角色管理")]),s._v(" "),n("p",[s._v("MySQL8.0 提供了角色管理的新功能，角色是一组权限的集合。")]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/mysql/6/img.png",alt:""}})]),s._v(" "),n("p",[s._v("在 MySQL8.0 中创建角色，创建的角色会被对应的写到 mysql.user 表中，并且是没有密码的，所以角色相当于一个用户。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建角色")]),s._v("\ncreate role "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户信息")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" host,user,authentication_string from mysql.user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("角色授权，授权可以授权对应的操作权限（），并指定给哪个库，哪些表，* 代表所有表，然后给具体某个角色授权。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("grant select,insert,update,delete on testdb.* to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("用户授权")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 赋予用户权限")]),s._v("\ngrant "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),s._v(" to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户拥有哪些角色")]),s._v("\nshow grants "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户拥有哪些角色和具体的权限")]),s._v("\nshow grants "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),s._v(" using "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("用户授权后，我们可以更换用户进行登录，来对我们授权的用户和库进行操作。当被授权用户登录的时候，可能还是没有权限对库进行操作，需要当前用户给自己设置角色才行，类似于启用这个角色。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看当前用户所拥有的的角色，没有则为 NONE")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" currnt_role"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前用户给自己设置角色")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" role "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("当然每次给用户设置角色后，用户登录都需要自己启用这个角色是相当麻烦的，那我们可以设置默认角色。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果要取消，则可角色名称可以为NONE")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" default role "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),s._v(" to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果有多个角色想要给某个账户设置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" default role all to "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("如果想要查询 mysql 中关于角色相关的一些信息，可以通过 mysql 库中的 default_roles 和 role_edges;")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会查出有哪些已被设置默认的角色和用户")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from mysql.default_roles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 角色授予的信息表，知道那个角色授予哪个用户（角色在mysql中是一种特殊的用户）")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from mysql.role_edges"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("对于角色来说，可以赋予角色相关的动作权限，当然也可以移除动作权限")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 移除角色对于testdb库的所有表的增删改权限")]),s._v("\nrevoke insert,update,delete on testdb.* from "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看角色动作")]),s._v("\nshow grants "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户对应角色和动作权限")]),s._v("\nshow grants "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'账户名称'")]),s._v(" using "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'角色名称'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"优化器索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化器索引"}},[s._v("#")]),s._v(" 优化器索引")]),s._v(" "),n("h3",{attrs:{id:"隐藏索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#隐藏索引"}},[s._v("#")]),s._v(" 隐藏索引")]),s._v(" "),n("p",[s._v("MySQL8.0 开始支持隐藏索引（invisible index），不可见索引。隐藏索引不会被优化器使用，但任然需要进行维护，也就是数据的修改任然需要在后台进行索引的维护，依然有维护成本。隐藏索引多用于以下两个场景：")]),s._v(" "),n("ul",[n("li",[s._v("软删除，索引是需要维护成本的，如果某些表不需要索引可以直接删掉，但后期又要加索引，在数据量比较大的时候成本比较高，所以软删除提供隐藏索引，把索引设置为隐藏，这个时候查询优化器并不会使用索引，但依然会进行维护，当最终确定删除的时候，我们在将索引彻底删除。")]),s._v(" "),n("li",[s._v("灰度发布，这种方式通常用来做索引测试，在设计之初加上并设置为隐藏，当后期如果索引实际用到，我们则可以打开（加索引也需要成本，尤其数据量大）")])]),s._v(" "),n("p",[s._v("隐藏缩影的创建语句")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 普通索引创建")]),s._v("\ncreate index "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'索引名称'")]),s._v(" on 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("字段"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 隐藏索引则是多了一个关键字 invisible")]),s._v("\ncreate index "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'索引名称'")]),s._v(" on 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("字段"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" invisible"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我们可以通过语句来看索引是否可见，查看关键字 Visible")]),s._v("\nshow index from 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("G\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("我们可以实际测试，并使用 explain select ... 语句来验证。"),n("br"),s._v("\n通过语句也可以改变索引的可见和不可见。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置为可见索引")]),s._v("\nalter table 表名 alter index "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'索引名'")]),s._v(" visible"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置为隐藏索引")]),s._v("\nalter table 表名 alter index "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'索引名'")]),s._v(" invisible"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("blockquote",[n("p",[s._v("主键是不能设置隐藏索引的")])]),s._v(" "),n("h3",{attrs:{id:"降序索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#降序索引"}},[s._v("#")]),s._v(" 降序索引")]),s._v(" "),n("p",[s._v("MySQL8.0 之前也可以使用降序索引的定义，但实际上 MySQL 服务会忽略我们这个定义，创建的还是升序索引，但是从 MySQL8.0 开始真正的支持了降序索引（descending index），但目前来说只有 innoDB 存储引擎支持降序索引，只支持 BTREE 降序索引。并且由于降序索引的引入，MySQL8.0 不再对 group by 操作进行隐式排序。")]),s._v(" "),n("p",[s._v("创建表并构建降序索引")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 test表 并未c1和c2字段添加升序和降序索引")]),s._v("\ncreate table test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  c1 int ,\n  c2 int,\n  index idx1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c1 asc,c2 desc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看创建表的索引，发现 c2 后面会多一个 desc 降序索引，asc 升序索引默认不显示")]),s._v("\nshow create table test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("G\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"函数索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#函数索引"}},[s._v("#")]),s._v(" 函数索引")]),s._v(" "),n("p",[s._v("具体的函数索引是在 MySQL8.0.13 开始支持在索引中使用函数（表达式）的值，新的函数索引支持降序索引，支持 JSON 数据的索引。函数索引是基于虚拟列功能实现的。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将列名的大写转换作为索引的值")]),s._v("\ncreate index "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'索引名称'")]),s._v(" on 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("UPPER"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("列名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过语句查看，可以通过关键字 Expression 查看")]),s._v("\nshow index from 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("G\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("触发优化器函数索引的语句")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("explain "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from 表名 where upeer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("列名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'C'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("函数索引对 JSON 进行索引，先要创建索引")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个表，字段data为JSON类型，并为其创建一个索引，CAST做类型转换。取json中name节点的值，并把数据转换成char(30)。")]),s._v("\ncreate table test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  data json,\n  index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CAST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),s._v(" as char"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看该表索引情况")]),s._v("\nshow index from 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("G\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 触发索引语句")]),s._v("\nexplain "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" where CAST"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),s._v(" as char"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aaa'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("如上所说函数索引是基于虚拟列功能实现的，可以理解成一下几步")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 改变表添加一个新字段，值是以旧字段的值并转大写为结果")]),s._v("\nalter table 表名 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("column")]),s._v(" 新字段 varchar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" generated always as "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("upper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("旧字段"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 建立索引")]),s._v("\ncreate index 索引名称 on 表名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("新字段"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 触发索引，会发现走的是新字段的索引")]),s._v("\nexplain "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from 表名 where upper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("旧字段"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AAA'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("我们还可以把 JSON 里面的某个属性提取为一个虚拟列，当 JSON 里该属性的值发生变化，则虚拟列也会更新，然后对虚拟列做上索引，这样就会对查询速度有所提升。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("ALTER TABLE 表名 ADD COLUMN "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'虚拟列名称'")]),s._v(" VARCHAR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" generated always AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\tjson_unquote"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\tjson_extract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'json字段名'")]),s._v(",_utf8mb4"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.属性'")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" virtual NULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"通用表表达式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#通用表表达式"}},[s._v("#")]),s._v(" 通用表表达式")]),s._v(" "),n("h3",{attrs:{id:"非递归-cte"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#非递归-cte"}},[s._v("#")]),s._v(" 非递归 CTE")]),s._v(" "),n("p",[s._v("MySQL8.0 开始支持通用表表达式（CTE），即 WITH 字句。简单示例如下：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以前子查询或派生表")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("select "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通用表表达式")]),s._v("\nwith "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" as "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("select "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通用表表达式")]),s._v("\nwith dd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("select "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n  dd2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("select id+1 from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" dd2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"递归-cte"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#递归-cte"}},[s._v("#")]),s._v(" 递归 CTE")]),s._v(" "),n("p",[s._v("递归 CTE 在查询中引用自己的定义，使用 recursive 表示，示例:")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("with recursive dd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" as"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  union all\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" n+1 from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" where n "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("递归限制，递归表达式的查询中需要包含个终止递归的条件")]),s._v(" "),n("ul",[n("li",[s._v("cte_max_recursion_depth：最大递归的深度，如果没有条件终止，达到这个条件系统会提示错误")]),s._v(" "),n("li",[s._v("max_execution_time：SQL 语句的最多执行时间，如果执行语句超过这个时间也会提示错误")])]),s._v(" "),n("p",[s._v("查看参数")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看系统默认深度")]),s._v("\nshow variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cte_max%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以修改这个参数，session 为当前会话有效")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" session "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cte_max_recursion_depth")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看系统默认SQl执行时间，默认是0，没有限制，单位s")]),s._v("\nshow variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'max_execution%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" session "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("max_execution_time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("CTE 支持 select，insert，update，delete 等语句。")]),s._v(" "),n("h2",{attrs:{id:"窗口函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#窗口函数"}},[s._v("#")]),s._v(" 窗口函数")]),s._v(" "),n("p",[s._v("MySQL8.0 支持窗口函数（Window Function），也称为分析函数。窗口函数与分组聚合函数类似，但是每一行数据都生成一个结果。聚合窗口函数：sum/avg/count/max/min 等等都可以作为窗口函数来使用。")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 创建表\nCREATE TABLE `sales` (\n  `year` int DEFAULT NULL,\n  `country` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n  `product` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n  `profit` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n# 表数据\nINSERT INTO `sales` VALUES(2000,'F','C',1500),\n(2001,'U','C',1200),\n(2001,'F','P',10),\n(2000,'I','Ca',75),\n(2000,'U','T',150),\n(2001,'I','C',1200),\n(2000,'U','Ca',5),\n(2000,'U','C',1500),\n(2000,'F','p',100),\n(2001,'U','Ca',50),\n(2001,'U','C',1500),\n(2000,'I','Ca',75),\n(2001,'U','T',100);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("我们查询每个国家的利润总和，先用聚合函数实现：")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT country,SUM"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("profit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS country_profit FROM sales\nGROUP BY country ORDER BY country\n\ncountry  country_profit  \n-------  ----------------\nF                    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("\nI                    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1350")]),s._v("\nU                    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4505")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("我们用分析函数的写法")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("SELECT YEAR,country,product,profit,\n\t# 按照国家分区\n\tSUM(profit) over (PARTITION BY country) AS country_profit\nFROM sales\nORDER BY country,YEAR,product,profit\n\n  year  country  product  profit  country_profit  \n------  -------  -------  ------  ----------------\n  2000  F        C        1500                1610\n  2000  F        p        100                 1610\n  2001  F        P        10                  1610\n  2000  I        Ca       75                  1350\n  2000  I        Ca       75                  1350\n  2001  I        C        1200                1350\n  2000  U        C        1500                4505\n  2000  U        Ca       5                   4505\n  2000  U        T        150                 4505\n  2001  U        C        1200                4505\n  2001  U        C        1500                4505\n  2001  U        Ca       50                  4505\n  2001  U        T        100                 4505\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h3",{attrs:{id:"专用窗口函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#专用窗口函数"}},[s._v("#")]),s._v(" 专用窗口函数")]),s._v(" "),n("p",[s._v("除以上聚合函数也可以用来做窗口函数外，还提供了一些专用窗口函数。")]),s._v(" "),n("ul",[n("li",[s._v("ROW_NUMBER () 用于数据排名的排名函数；")]),s._v(" "),n("li",[s._v("RANK()")]),s._v(" "),n("li",[s._v("DENSE_RANK()")]),s._v(" "),n("li",[s._v("PERCENT_RANK()")]),s._v(" "),n("li",[s._v("FIRST_VALUE () 用于获取窗口分组内的第一名；")]),s._v(" "),n("li",[s._v("LAST_VALUE ()，用于获取窗口分组内的最后一名；")]),s._v(" "),n("li",[s._v("LEAD () 用于获取当前的后几名数据；")]),s._v(" "),n("li",[s._v("LAG () 用于获取当前的前几名数据；")]),s._v(" "),n("li",[s._v("CUME_DIST ()，累计分布，数据累计到现在占了多少；")]),s._v(" "),n("li",[s._v("NTH_VALUE ()，排名第几名的函数；")]),s._v(" "),n("li",[s._v("NTILE (Num)，传入一个整数，把数据级按照整数分组（分为多少个组）;")])]),s._v(" "),n("p",[s._v("创建示例表和数据")]),s._v(" "),n("div",{staticClass:"language-mysql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 表\nCREATE TABLE `numbers` (\n  `val` int DEFAULT NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci\n\n# 插入语句\nINSERT INTO `numbers`\nVALUES(1),(1),(2),(3),(3),(3),(3),(4),(4),(5);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("对 numbers 表数据进行排名")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT val,row_number"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ORDER BY val"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'row_number'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("numbers"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n   val  row_number  \n------  ------------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT val,\n\tfirst_value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("val"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ORDER BY val"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'first'")]),s._v(",\n\tlead"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("val,1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ORDER BY val"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lead'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("numbers"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n   val   first    lead  \n------  ------  --------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("NULL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT val,\n\tntile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ORDER BY val"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ntile3'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("numbers"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n   val  ntile3  \n------  --------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"窗口定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#窗口定义"}},[s._v("#")]),s._v(" 窗口定义")]),s._v(" "),n("p",[s._v("窗口和其他函数最大的区别是 over 关键字，over 中可以有多个条件")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("window_function"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("expr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会对数据先进行分组")]),s._v("\n  partition by "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对于数据排序")]),s._v("\n  order by "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 会进一步限定窗口")]),s._v("\n  frame_clause"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("frame_clause 定义了一些常用的关键字，如：")]),s._v(" "),n("ul",[n("li",[s._v("current_row，当前行")]),s._v(" "),n("li",[s._v("m preceding，如 1 preceding，则表示和当前行的上一行，也就是已经处理过的行，进行计算")]),s._v(" "),n("li",[s._v("n following，如 2 following，则表示和当前行往下的两行，还没有被处理的行")]),s._v(" "),n("li",[s._v("unbounded preceding，从分区中的第一行开始，延续往下处理所有数据，直到分区最后一行")]),s._v(" "),n("li",[s._v("unbounded following，表示分区的最后一行")])]),s._v(" "),n("p",[n("img",{attrs:{src:"/assets/img/mysql/6/img_1.png",alt:""}})]),s._v(" "),n("p",[s._v("如图，当前行为 | 2,001 | USA | TV | 150 |，对于当前行的 unbounded preceding 来说是当前行以上的所有数据，对于当前行的  unbounded following 来说是当前行以下的所有数据，而 1 preceding，为当前行的上一行，2 following，则为当前行的下一行。")]),s._v(" "),n("p",[s._v("针对以上的 sales 表，按国家进行分区计算利润总和，按照分组内的产品进行排序，并在分区内计算利润累计和")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT *,\n\tSUM"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("profit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\tPARTITION BY country\n\t\tORDER BY product\n\t\tROWS unbounded preceding\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sum profit'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("sales"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n  year  country  product  profit  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" profit  \n------  -------  -------  ------  ------------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  F        P        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1510")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        p        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  I        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1275")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1350")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2700")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4200")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("               "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4205")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4255")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4405")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("             "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4505")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("针对以上的 sales 表，按国家进行分区计算利润总和，按照分组内的产品进行排序，并在分区内计算"),n("strong",[s._v("上一行和当前行以及下一行")]),s._v("进行利润加和计算")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT *,\n\tSUM"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("profit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\tPARTITION BY country\n\t\tORDER BY product\n\t\tROWS BETWEEN "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" preceding AND "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" following\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sum profit'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("sales"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n  year  country  product  profit  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),s._v(" profit  \n------  -------  -------  ------  ------------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1510")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  F        P        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1610")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        p        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  I        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1275")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1350")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("               "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2700")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4200")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("            "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3005")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("               "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1555")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("               "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("205")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("              "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("250")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT *,\n\tfirst_value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("profit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over w AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'first'")]),s._v(",\n\tlast_value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("profit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over w AS "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'last'")]),s._v("\nFROM "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("sales"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\nwindow w AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\tPARTITION BY country \n\tORDER BY profit\n\tROWS unbounded preceding\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  year  country  product  profit  first   last    \n------  -------  -------  ------  ------  --------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  F        P        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        p        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  F        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  I        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("      \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  I        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("      \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1200")]),s._v("    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        T        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v("     \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        C        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("       \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v("  U        Ca       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("      \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h2",{attrs:{id:"innodb增强"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#innodb增强"}},[s._v("#")]),s._v(" InnoDB 增强")]),s._v(" "),n("h3",{attrs:{id:"集成数据字典"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#集成数据字典"}},[s._v("#")]),s._v(" 集成数据字典")]),s._v(" "),n("p",[s._v("MySQL8.0 删除了之前版本的元数据文件，例如 .frm，.opt，关于触发器的一些 trigger 文件等，我们可以在新老版本的 /var/lib/mysql/mysql 下查看文件信息。")]),s._v(" "),n("p",[s._v("将系统表（mysql 数据库）和数据字典全部改为 InnoDB 存储引擎，从 8.0 之后，所有的数据字典信息都是用 innoDB 存储引擎进行统一的存储。")]),s._v(" "),n("p",[s._v("简化了 information_schema 的实现，提高了访问性能。")]),s._v(" "),n("h3",{attrs:{id:"原子ddl操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原子ddl操作"}},[s._v("#")]),s._v(" 原子 DDL 操作")]),s._v(" "),n("p",[s._v("MySQL8.0 开始支持原子 DDL 操作，其中与表相关的原子 DDL 只支持 InnoDB 引擎。一个原子 DDL 操作内容包括：更新数据字典，存储引擎层的操作，在 binlog 中记录 DDL 操作，有了这几个步骤后，如果我们在这个操作出现了服务器崩溃，可以通过相应的恢复机制进行数据的重做或者是数据的回滚来保证我们 DDL 操作的事务原子性。")]),s._v(" "),n("p",[s._v("支持与表相关的 DDL：数据库、表空间、表、索引的 create、alter、drop 以及 truncate table。")]),s._v(" "),n("p",[s._v("支持其他的 DDL：存储程序、触发器、视图、UDF 的 create、drop 以及 alter 语句。")]),s._v(" "),n("p",[s._v("支持账户管理相关的 DDL：用户和用户角色的 create、alter、drop 以及适用的 rename，以及 grant 和 revoke 语句。")]),s._v(" "),n("p",[s._v("可以在 5.7 和 8 中使用以下方式进行测试，在 5.7 中删除语句会报错，但 t1 表依然会删除成功，在 8 中，删除失败，但表 t1 依然存在。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建表")]),s._v("\ncreate table t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id int"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除表t1，t2")]),s._v("\ndrop table t1,t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"自增列持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自增列持久化"}},[s._v("#")]),s._v(" 自增列持久化")]),s._v(" "),n("p",[s._v("MySQL5.7 以及早期版本，InnoDB 自增列计数器（auto_invcrement）的值只存储在内存中，当服务器故障或重启，mysql 会扫描自增列，找到当前的最大值，然后基于该值往上自增，在某些场景，初始化的值有可能是以前使用过的值，有可能会重复，通常来说我们使用自增配合主键一起使用，不允许有重复的列。")]),s._v(" "),n("p",[s._v("基于以上原因，MySQL8.0 每次变化时将自增计数器的最大值写入 redo log，同时在每次检查点将其写入引擎私有的系统表，如果系统下次重启恢复的时候，他可以通过写入的记录找到我们曾经使用或可能使用过的最大值，避免我们新生成的值和我们之前使用过的值重复的情况。")]),s._v(" "),n("p",[s._v("在 5.7 问题存在的演示")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建测试表")]),s._v("\ncreate table t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" int auto_increment primary key,\n  c1 varchar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据插入")]),s._v("\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'b'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'c'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("       c1\n------  -------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        a   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        b   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("        c    \n   \n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除数据")]),s._v("\ndelete from t where "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("       c1\n------  -------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        a   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        b   \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启数据库，并插入数据")]),s._v("\n\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'d'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("       c1\n------  -------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        a   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        b   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("        d    \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新值")]),s._v("\nupdate t "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" where c1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("       c1\n------  -------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        b   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("        d    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("        a   \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 插入新数据")]),s._v("\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'e'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("       c1\n------  -------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("        b   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("        d    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("        e    \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("        a   \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次插入数据，会报错 Duplicate entry '5' from key 'PRIMARY'")]),s._v("\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'f'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br")])]),n("p",[s._v("以上步骤如果使用 MySQL8.0 操作，你会发现在删除数据后重新启动并插入数据，此时 ID 为以前没被使用过的。如果像以上 update，再生成一条新的记录，则也不会出现主键重复的错误。")]),s._v(" "),n("p",[s._v("我们可以通过查看 innodb_autoinc_lock_mode 参数来发现他们的区别，在 5.7 中该值为 1（连续模式），在 8.0 中该值为 2（交叉模式），如果你使用基于语句的复制模式，要使用 1，如果是基于行的复制，使用 2，该方式可以提高性能。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("show variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_autoinc%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"死锁检查控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死锁检查控制"}},[s._v("#")]),s._v(" 死锁检查控制")]),s._v(" "),n("p",[s._v("死锁是两个事务，它都需要进行一些数据的修改，而在修改的过程中，他们都需要等待对方释放某一些数据上的资源，因为他们互相之间没有感知，如果没有外界系统的介入的情况下，他们会一直等待下去，也就是这两个事务形成了一个死锁。")]),s._v(" "),n("p",[s._v("在 MySQL8.0 中，在后台会有一个实时监测的程序，它如果发现这种情况，它会让一个事务失败，而让另一个事务能够进行下去。当然，这个死锁检查它需要一定的代价，需要占用一定的系统资源。")]),s._v(" "),n("p",[s._v("MySQL8.0（5.7.15）增加了一个新的动态变量（innodb_deadlock_detect），用于控制系统是否执行 InnoDB 死锁检查。对于高并发的系统，禁用死锁检查可以带来性能的提高。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("show variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_deadlock_detect'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("以下提供了测试语句，当发生死锁的时候，会让一个事务进行报错，另一个成功。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启第一个窗口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建测试表")]),s._v("\ncreate table t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  item int\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据插入")]),s._v("\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启事务")]),s._v("\nstart transaction"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取记录上的共享锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from t where item "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" share"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第二个窗口，同样开启事务并删除数据，删除数据记录需要相应的排他锁，但第一个窗口已经占用了共享锁，所以下面删除语句会进行等待")]),s._v("\ndelete from t where item "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第一个窗口，也键入删除语句，此时这条语句需要以上释放锁才能继续进行下去，固然形成了死锁。")]),s._v("\ndelete from t where item "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("当我们关闭死锁检查的时候，还有个参数会帮我们进行限制，锁等待超时（innodb_lock_wait_timeout）")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭死锁检查")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_deadlock_detect")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看innodb_lock_wait_timeout默认时间，默认50s")]),s._v("\nshow variables like "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_lock_wait%'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以把锁超时时间设置短一些")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("innodb_lock_wait_timeout")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("进行设置完毕后，我们可以重复上面事务的死锁案例，它会报出如下错误")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Lock wait timeout exceeded；try restarting transaction\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"锁定语句选项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#锁定语句选项"}},[s._v("#")]),s._v(" 锁定语句选项")]),s._v(" "),n("p",[s._v("在 MySQL 中的有两个可以对执行语句加锁的选项，select ... for share（共享锁 - 读锁） 和 select ...for update（排他锁 - 写锁） ，如果所查询的数据在其他事务中已经占用了相应的锁，那我们的语句需要做相应的等待，直到相应的事务释放锁，如果一直没有等待到，它会在等待超时后执行报错。")]),s._v(" "),n("p",[s._v("新的 8.0 对对两条加锁语句进行了两个选项")]),s._v(" "),n("ul",[n("li",[s._v("nowait 如果请求的行被其他事务锁定时，语句立即返回")]),s._v(" "),n("li",[s._v("skip locked 如果对查询的数据有些已经被锁定，跳过这些锁定的行，只返回没有被锁定的数据")])]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开第一个会话窗口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建测试表")]),s._v("\ncreate table t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  item int\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据插入")]),s._v("\ninsert into t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启事务")]),s._v("\nstart transaction"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改语句，会自动添加排他锁，这里不进行commit不会释放锁")]),s._v("\nupdate t "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("iitem")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" where item "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第二个窗口，同样开启事务，并执行语句，该语句会被阻塞等待超时")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from t where "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("i")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" update"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第三个窗口，同样开启事务，并执行语句，该语句会立即返回报错")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from t where "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("i")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" update nowait"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nStatement aborted because lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" could not be acquired immediately and nowait is set.\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第四个窗口，同样开启事务，并执行语句，该语句会立即返回结果.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" * from t where "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("i")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" update skip locked"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nitem   \n------\n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   \n  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("      \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到第一个窗口，也键入删除语句，此时这条语句需要以上释放锁才能继续进行下去，固然形成了死锁。")]),s._v("\ndelete from t where item "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h2",{attrs:{id:"json增强"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#json增强"}},[s._v("#")]),s._v(" JSON 增强")]),s._v(" "),n("p",[s._v("JSON 的数据类型在 MySQL5.7 就已经出了，只是到 8.0 得到了一些增强")]),s._v(" "),n("ul",[n("li",[s._v("内联路径操作符 -> 它主要是用于获取 JSON 对象在某一些节点或者某些路径上面的一些数据值")]),s._v(" "),n("li",[s._v("JSON 的聚合函数 -> 他可以将我们这种表中的列数据聚合成对应的 JSON 数组或者是 JSON 的对象")]),s._v(" "),n("li",[s._v("JSON 实用函数 -> json 的实用函数主要是用于美观我们 JSON 对象输出，或是获取 JSON 对象所占用的存储空间")]),s._v(" "),n("li",[s._v("JSON 的合并函数 -> 主要是将两个 JSON 对象合并成一个")]),s._v(" "),n("li",[s._v("JSON 表函数 -> 它和聚合函数执行相反的操作，是将 JSON 的对象扩展成我们关系型数据库表，按照行和列方式组织数据")])]),s._v(" "),n("h3",{attrs:{id:"内联路径操作符"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内联路径操作符"}},[s._v("#")]),s._v(" 内联路径操作符")]),s._v(" "),n("p",[s._v("MySQL8.0 增加了 JSON 操作字符  "),n("code",[s._v("column ->> path")]),s._v(" ，等价于：之前版本  "),n("code",[s._v("JSON_UNQUOTE(column -> path)")]),s._v(" ，  "),n("code",[s._v("JSON_UNQUOTE(JSON_EXTRACT(column,path))")]),s._v(" 。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式一 JSON_UNQUOTE使用方式")]),s._v("\nWITH doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(",3,"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\nSELECT json_unquote"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" FROM doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_unquote"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n--------------------------------\nzs                              \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式二 JSON_UNQUOTE(json_extract())使用方式")]),s._v("\nWITH doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(",3,"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\nSELECT json_unquote"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json_extract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json,"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v(" FROM doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_unquote"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json_extract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json,"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("  \n-------------------------------------------\nzs                                         \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式三  ->>")]),s._v("\nWITH doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(",3,"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\nSELECT json -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),s._v(" FROM doc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$.name'")]),s._v("  \n-------------------\nzs                 \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("p",[s._v("MySQL8.0 内联路径操作符还扩展了范围操作")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以前版本")]),s._v("\nSELECT json_extract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'["a","b","c"]\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[1]'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_extract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'["a","b","c"]\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[1]'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n--------------------------------------\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v("                                   \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 现在版本 支持范围")]),s._v("\nWITH dd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'["a","b","c"]\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nSELECT json -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[1 to 3]'")]),s._v(" FROM "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[last-2 to last]'")]),s._v("  \n------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("               \n\n\nWITH dd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'["a","b","c"]\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nSELECT json -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[last-2 to last]'")]),s._v(" FROM "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson -"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'$[last-2 to last]'")]),s._v("  \n------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("               \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h3",{attrs:{id:"json的聚合函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#json的聚合函数"}},[s._v("#")]),s._v(" JSON 的聚合函数")]),s._v(" "),n("p",[s._v("MySQL8.0 增加了 2 个用于聚合的函数：")]),s._v(" "),n("ul",[n("li",[s._v("JSON_ARRAYAGG () -> 用于将多行数据组合成一个 JSON 数组")]),s._v(" "),n("li",[s._v("JSON_OBJECTAGG () -> 用于生成一个 JSON 对象")])]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建表")]),s._v("\nCREATE TABLE "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" int DEFAULT NULL,\n  "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("att"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" varchar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" COLLATE utf8mb4_unicode_ci DEFAULT NULL,\n  "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("value"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" varchar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" COLLATE utf8mb4_unicode_ci DEFAULT NULL\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ENGINE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("InnoDB DEFAULT "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CHARSET")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("COLLATE")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4_unicode_ci\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新增数据")]),s._v("\nINSERT INTO t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id,att,VALUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("VALUES\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'color'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'red'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fabric'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'silk'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'color'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'green'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'shape'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'square'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转成数组")]),s._v("\nSELECT id,json_arrayagg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("att"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS attributes\nFROM t GROUP BY "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("  attributes           \n------  ---------------------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fabric"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  \n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shape"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 转成对象")]),s._v("\nSELECT id,json_objectagg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("att,VALUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS attributes\nFROM t GROUP BY "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("  attributes                             \n------  ---------------------------------------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"red"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fabric"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"silk"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("     \n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"green"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shape"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"square"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果有相同属性，只会读取最后一个重复属性的值")]),s._v("\nINSERT INTO t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id,att,VALUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("VALUES "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'color'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yellow'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("  attributes                             \n------  ---------------------------------------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"red"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fabric"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"silk"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("     \n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"color"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yellow"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shape"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"square"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("h3",{attrs:{id:"json实用函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#json实用函数"}},[s._v("#")]),s._v(" JSON 实用函数")]),s._v(" "),n("ul",[n("li",[s._v("(5.7.22 加入了该函数) JSON_PRETTY ()，在我们输出 JSON 对象内容的时候做一个格式化，一个美化的输出")]),s._v(" "),n("li",[s._v("(5.7.22 加入了该函数) JSON_STORAGE_SIZE ()，返回 JSON 数据所占用的存储空间")]),s._v(" "),n("li",[s._v("JSON_STORAGE_FREE ()，在更新某些 JSON 的列，计算出字段释放出来的存储空间")])]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认情况下的JSON格式")]),s._v("\nSELECT json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\njson_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n-----------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zs"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("          \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#美化后的JSON输出")]),s._v("\nSELECT json_pretty"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_pretty"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("  \n------------------------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                               \n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v(",                                    \n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zs"')]),s._v("                                  \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                                               \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#查看JSON占用大小，默认字节(B)")]),s._v("\nWITH dd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SELECT json_pretty"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'id'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'name'")]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nSELECT json,json_storage_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" FROM "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson                             json_storage_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n-------------------------------  -------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                                       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v(",                                              \n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zs"')]),s._v("                                            \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                                                         \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h3",{attrs:{id:"json的合并函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#json的合并函数"}},[s._v("#")]),s._v(" json 的合并函数")]),s._v(" "),n("ul",[n("li",[s._v("JSON_MERGE_PATCH ()，将两个 JSON 对象合并成一个对象，如果两个对象当中有相同的节点，它会使用第二个对象中的节点覆盖第一个节点")]),s._v(" "),n("li",[s._v("JSON_MERGE_PRESERV ()，将两个 JSON 对象合并成一个对象，如果存在两个相同的节点，会保留两个节点的值")]),s._v(" "),n("li",[s._v("JSON_MERGE ()，这个函数和上一个函数相似，但在 8.0 中已经被废弃")])]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT json_merge_patch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":1,"b":2}\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":3,"c":4}\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_merge_patch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":1,"b":2}\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":3,"c":4}\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n---------------------------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                           \n\nSELECT json_merge_preserve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":1,"b":2}\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":3,"c":4}\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\njson_merge_preserve"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":1,"b":2}\'')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"a":3,"c":4}\'')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n------------------------------------------------------\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                         \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"json表函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#json表函数"}},[s._v("#")]),s._v(" JSON 表函数")]),s._v(" "),n("p",[s._v("8.0 新增 JSON_TABLE ()，将 JSON 格式的数据转换为关系表格式，返回的结果可以当做一个普通标，使用 SQL 进行查询。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("SELECT * FROM  json_table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 模拟数据，或某个表的数据")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'[{"a":"1"},{"a":2},{"b":3},{"a":2},{"a":[1,2,3,4]}]\'')]),s._v(",\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定json中的那元数据作为一个转换，这里可以通过数组下表匹配，*表示所有数据")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$[*]"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("COLUMNS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定关系表结构列的定义")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id列，生成一个数字序列")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" FOR ordinality,\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个a字段，取json中a这个属性的值，当转换错无的时候显示 -1，当没有相应的属性显示为 -2，这里错误默认值一定不能是字符串")]),s._v("\n\t\ta VARCHAR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" path "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$.a"')]),s._v(" DEFAULT "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-1'")]),s._v(" ON error DEFAULT "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-2'")]),s._v(" ON empty,\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义a属性的JSON字段，为空则显示默认JSON")]),s._v("\n\t\ta_j json path "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$.a"')]),s._v(" DEFAULT "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{\"a\":333}'")]),s._v(" ON empty,\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个b字段，用于判断路径是否存在b这个属性")]),s._v("\n\t\tb INT EXISTS path "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$.b"')]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" AS t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("  a       a_j                b  \n------  ------  ------------  --------\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v("                  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("                    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  -2      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("333")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("           "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("                    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  -1      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("         "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);