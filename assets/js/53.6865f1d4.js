(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{528:function(e,t,a){"use strict";a.r(t);var i=a(41),n=Object(i.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"spring-cloud-sleuth"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-sleuth"}},[e._v("#")]),e._v(" spring cloud sleuth")]),e._v(" "),a("p",[e._v("提供链路追踪。通过 sleuth 可以很清楚的看出一个请求都经过了哪些服务；可以很方便的理清服务间的调用关系。")]),e._v(" "),a("p",[e._v("可视化错误。对于程序未捕捉的异常，可以结合 zipkin 分析。")]),e._v(" "),a("p",[e._v("分析耗时。通过 sleuth 可以很方便的看出每个采样请求的耗时，分析出哪些服务调用比较耗时。当服务调用的耗时随着请求量的增大而增大时，也可以对服务的扩容提供一定的提醒作用。")]),e._v(" "),a("p",[e._v("从官网得知 从 2.1.0 版开始，Spring Cloud Sleuth 支持将跟踪发送到多个跟踪系统，且去掉了 spring cloud streaming，那如果只引入 sleuth 包，不同机器服务之间相互调用是否还能实现链路追踪？经过测试答案是可以的，源码这里我没研究，但是从技术角度要自己实现，其实只要在 header 里添加一个值 (唯一)，在上下游服务之间传递，便可行。")]),e._v(" "),a("p",[e._v("所以结论是如果只是单纯为了使用链路追踪在控制台看，只引入 sleuth 是已经足够的。")]),e._v(" "),a("h2",{attrs:{id:"spring-cloud-zipkin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-zipkin"}},[e._v("#")]),e._v(" spring cloud zipkin")]),e._v(" "),a("p",[e._v("Zipkin 是 Twitter 的一个开源项目，我们可以使用它来收集各个服务器上请求链路的跟踪数据，并通过它提供的 API 接口来辅助查询跟踪数据以分布式系统的监控程序，通过 UI 组件帮助我们及时发现系统中出现的延迟升高问题以及系统性能瓶颈根源。")]),e._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/spring/cloud/5/1.jpg",alt:"Zipkin的基础架构"}})]),e._v(" "),a("p",[e._v("Collector（收集器组件）-> 主要负责收集外部系统跟踪信息，转化为 Zipkin 内部的 Span 格式。")]),e._v(" "),a("p",[e._v("Storage（存储组件）-> 主要负责收到的跟踪信息的存储，默认为存储在内存中，同时支持存储到 Mysql、Cassandra 以及 ElasticSearch。")]),e._v(" "),a("p",[e._v("API（Query）-> 负责查询 Storage 中存储的数据，提供简单的 JSON API 获取数据，主要提供给 web UI 使用。")]),e._v(" "),a("p",[e._v("Web UI（展示组件）-> 提供简单的 web 界面，方便进行跟踪信息的查看以及查询，同时进行相关的分析。")]),e._v(" "),a("p",[e._v("Instrumented Client 和 Instrumented Server，是指分布式架构中使用了 Trace 工具的两个应用，Client 会调用 Server 提供的服务，两者都会向 Zipkin 上报 Trace 相关信息。在 Client 和 Server 通过 Transport 上报 Trace 信息后，由 Zipkin 的 Collector 模块接收，并由 Storage 模块将数据存储在对应的存储介质中，然后 Zipkin 提供 API 供 UI 界面查询 Trace 跟踪信息。Non-Instrumented Server，指的是未使用 Trace 工具的 Server，显然它不会上报 Trace 信息。")]),e._v(" "),a("h2",{attrs:{id:"日志解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志解析"}},[e._v("#")]),e._v(" 日志解析")]),e._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('2020-06-19 11:10:44.967 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] Content-Length: 1921\n2020-06-19 11:10:44.967 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] Content-Type: application/json\n2020-06-19 11:10:44.968 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] \n2020-06-19 11:10:44.968 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] {"data":{"createTime":null,"updateTime":null,"deleteFlag":null,"id":null,"menuId":null,"name":null,"buildingDegree":null,"cityName":null,"cityId":null,"lng":null,"lat":null,"remarks":null},"token":"5a717dca1142d685c8aa54b45d0388c8","user":{"id":1,"account":"15771720565","name":"冯**","phone":"15771720565","onlineState":null,"remarks":"fdsafdsa","rolesId":1,"avatar":null,"token":"5a717dca1142d685c8aa54b45d0388c8","roles":{"id":1,"roleName":"超级管理员","remarks":"2222","menus":null},"menus":[{"id":1,"parentId":0,"menuName":"大屏展示","menuPath":"/dashboard","menuOrder":1000,"icon":"el-icon-monitor","remarks":null,"menuData":false,"menuButton":false,"child":[]},{"id":2,"parentId":0,"menuName":"数据分析","menuPath":"/dataAnalysis","menuOrder":2000,"icon":"el-icon-data-line","remarks":null,"menuData":false,"menuButton":false,"child":[]},{"id":3,"parentId":0,"menuName":"系统管理","menuPath":"/setting","menuOrder":3000,"icon":"el-icon-setting","remarks":null,"menuData":false,"menuButton":false,"child":[{"id":26,"parentId":3,"menuName":"用户管理","menuPath":"/setting/user","menuOrder":3100,"icon":null,"remarks":null,"menuData":false,"menuButton":false,"child":[]},{"id":5,"parentId":3,"menuName":"角色管理","menuPath":"/setting/roles","menuOrder":3200,"icon":null,"remarks":null,"menuData":false,"menuButton":false,"child":[]},{"id":6,"parentId":3,"menuName":"菜单管理","menuPath":"/setting/menus","menuOrder":3300,"icon":null,"remarks":null,"menuData":false,"menuButton":false,"child":[]}]},{"id":16,"parentId":0,"menuName":"电站管理","menuPath":"/electricityStation","menuOrder":4000,"icon":"el-icon-lightning","remarks":null,"menuData":false,"menuButton":false,"child":[{"id":17,"parentId":16,"menuName":"电站信息","menuPath":"/electricityStation/list","menuOrder":4100,"icon":null,"remarks":"列出所有电站","menuData":false,"menuButton":false,"child":[]}]}]}}\n2020-06-19 11:10:44.968 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] ---\x3e END HTTP (1921-byte body)\n2020-06-19 11:10:44.998 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] &lt;--- HTTP/1.1 200  (30ms)\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] connection: keep-alive\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] content-type: application/json\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] date: Fri, 19 Jun 2020 03:10:44 GMT\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] keep-alive: timeout=60\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] transfer-encoding: chunked\n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] \n2020-06-19 11:10:44.999 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] {"code":200,"msg":null,"data":[{"name":"平顶山","value":30},{"name":"西安","value":50},{"name":"北京","value":43}]}\n2020-06-19 11:10:45.000 DEBUG [bff-web-data-platform,368e435f7de29eff,368e435f7de29eff,false] 2516 --- [nio-8888-exec-5] c.giant.cloud.api.ElectricityStationApi  : [ElectricityStationApi#getDashboardElectricityStationData] &lt;--- END HTTP (122-byte body)\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br")])]),a("p",[e._v("[bff-web-data-platform, 368e435f7de29eff, 368e435f7de29eff, false] 解析：")]),e._v(" "),a("ul",[a("li",[e._v("bff-web-data-platform 称为 appname -> 应用名称")]),e._v(" "),a("li",[e._v("368e435f7de29eff 称为 traceId -> 为了追踪一个请求完整的流转过程，可以给每次请求分配一个唯一的 traceId，当请求调用其他服务时，通过传递这个 traceId。")]),e._v(" "),a("li",[e._v("368e435f7de29eff 称为 spanId -> 发生的特定操作的 ID")]),e._v(" "),a("li",[e._v("false 称为 exportable -> 是否应将日志导出到 Zipkin。")])]),e._v(" "),a("p",[e._v("无论是使用 sleuth 或是使用 zipkin 都会在控制台上输出这样的日志信息。"),a("br"),e._v(" "),a("a",{attrs:{href:"http://www.uml.org.cn/wfw/2019092314.asp",target:"_blank",rel:"noopener noreferrer"}},[e._v("借鉴博客"),a("OutboundLink")],1),a("br"),e._v(" "),a("a",{attrs:{href:"https://blog.csdn.net/u010257992/article/details/52474639",target:"_blank",rel:"noopener noreferrer"}},[e._v(" 2.1 以下版本中文文档，可以借鉴"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=n.exports}}]);