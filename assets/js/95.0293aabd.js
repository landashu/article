(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{572:function(s,a,t){"use strict";t.r(a);var r=t(41),e=Object(r.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"锁超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁超时"}},[s._v("#")]),s._v(" 锁超时")]),s._v(" "),t("p",[s._v("当出现  "),t("code",[s._v("Lock wait timeout exceeded; try restarting transaction")]),s._v(" ，可以通过以下 SQL 来排查：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("查看 InnoDB 存储引擎内部状态信息的命令，它可以提供非常详细的关于 InnoDB 存储引擎的运行状态、性能指标以及当前存在的问题等信息")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNODB")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("内容包括 "),t("code",[s._v("事物信息")]),s._v(" ， "),t("code",[s._v("锁信息")]),s._v(" ， "),t("code",[s._v("缓冲池信息")]),s._v(" ， "),t("code",[s._v("日志信息")]),s._v(" ， "),t("code",[s._v("表空间信息")]),s._v(" ，当程序发生以上报错信息，使用该语句，可以查看到相关报错信息。")])]),s._v(" "),t("li",[t("p",[s._v("查看当前被锁定或正在使用的表的命令。它能帮助你识别哪些表正在被事务或查询占用，从而排查锁等待、死锁等问题")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPEN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" In_use "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 示例")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------+-------------+--------+-------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Database")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Table")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" In_use "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Name_locked "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------+-------------+--------+-------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mydb     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" orders      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mydb     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" customers   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----------+-------------+--------+-------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" orders 表被锁定 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 次（可能有两个并发事务在操作它）。\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" customers 表被锁定 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 次。\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" 两个表的名称均未被锁定（Name_locked"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("），可正常进行 DML 操作。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ul",[t("li",[s._v("Database 表所在的数据库名称。")]),s._v(" "),t("li",[s._v("Table 表的名称。")]),s._v(" "),t("li",[s._v("In_use 表示当前正在使用的连接数。")]),s._v(" "),t("li",[s._v("Name_locked 表示当前表是否被锁定。")])])]),s._v(" "),t("li",[t("p",[s._v("看当前正在执行操作的线程（即非空闲连接）的 SQL 查询。它能帮助你监控数据库中活跃的查询和事务，排查性能问题或长时间运行的任务。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" information_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("PROCESSLIST "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" Command "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Sleep'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 示例")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-------+------+-------------------+--------+---------+------+------------------+----------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" ID    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" HOST              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" DB     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" COMMAND "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TIME")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" STATE            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" INFO                             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-------+------+-------------------+--------+---------+------+------------------+----------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" root "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" localhost         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mydb   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Query   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Sorting result   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" orders "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12346")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" app  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56789")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mydb   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Execute")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Sending "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" users "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-------+------+-----------+--------+---------+------+------------------+----------------------------------+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" 线程 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12345")]),s._v("：用户 root 在执行 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" 查询，已运行 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v(" 秒，正在排序结果（可能需要优化索引）。\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" 线程 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12346")]),s._v("：应用用户 app 在执行 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v("，运行 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 秒，正在返回数据。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[s._v("ID 线程 ID（唯一标识），用于 KILL 命令终止线程（如 KILL 12345;）。")]),s._v(" "),t("li",[s._v("USER 执行该线程的用户（如 root、app_user）。")]),s._v(" "),t("li",[s._v("HOST 客户端主机名或 IP 地址（如 localhost、192.168.1.1:56789）。")]),s._v(" "),t("li",[s._v("DB 当前线程操作的数据库名（若未指定则为 NULL）。")]),s._v(" "),t("li",[s._v("COMMAND 线程当前执行的命令类型：・Query：正在执行 SQL 查询。・Sleep：空闲等待。・Connect：正在连接数据库。・Execute：正在执行预处理语句。")]),s._v(" "),t("li",[s._v("TIME 线程已持续执行的时间（秒）。若值很大，可能是慢查询或事务未提交。")]),s._v(" "),t("li",[s._v("STATE 线程当前状态（如 Sorting result、Copying to tmp table），指示查询执行到哪一步。")]),s._v(" "),t("li",[s._v("INFO 正在执行的 SQL 语句（可能被截断，使用 SHOW FULL PROCESSLIST 可查看完整语句）。")])])])]),s._v(" "),t("p",[t("code",[s._v("SELECT * FROM information_schema.PROCESSLIST WHERE Command != 'Sleep';")]),s._v("  语句能方便的看到当前有哪个 sql 正在占有锁，可以看他的执行时间，如果太长，需要考虑是否优化，也可以立马 kill 这个线程，如果 kill 不起作用，需要重启 mysql。")])])}),[],!1,null,null,null);a.default=e.exports}}]);