(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{524:function(s,e,a){"use strict";a.r(e);var t=a(41),n=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"持续集成流程说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#持续集成流程说明"}},[s._v("#")]),s._v(" 持续集成流程说明")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img.png",alt:""}})]),s._v(" "),a("p",[s._v("1. 首先，开发人员每天进行代码提交，提交到 Git 仓库"),a("br"),s._v("\n 2. 然后，Jenkins 作为持续集成工具，使用 Git 工具到 Git 仓库拉取代码到集成服务器，再配合 JDK，Maven 等软件完成代码编译，代码测试与审查，测试，打包等工作，在这个过程中每一步出错，都重新再执行一次整个流程。"),a("br"),s._v("\n3. 最后，Jenkins 把生成的 jar 或 war 包分发到测试服务器或者生产服务器，测试人员或用户就可以访问应用。")]),s._v(" "),a("p",[a("strong",[s._v("服务器列表")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("名称")]),s._v(" "),a("th",[s._v("IP 地址")]),s._v(" "),a("th",[s._v("安装的软件")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("代码托管服务器")]),s._v(" "),a("td",[s._v("192.168.66.100")]),s._v(" "),a("td",[s._v("Gitlab-12.4.2")])]),s._v(" "),a("tr",[a("td",[s._v("持续集成服务器")]),s._v(" "),a("td",[s._v("192.168.66.101")]),s._v(" "),a("td",[s._v("Jenkins-2.190.3，JDK1.8，Maven3.6.2，Git，SonarQube")])]),s._v(" "),a("tr",[a("td",[s._v("测试或生产服务器")]),s._v(" "),a("td",[s._v("192.168.66.102")]),s._v(" "),a("td",[s._v("JDK1.8，Tomcat8.5")])])])]),s._v(" "),a("h2",{attrs:{id:"gitlab代码托管服务器安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab代码托管服务器安装"}},[s._v("#")]),s._v(" Gitlab 代码托管服务器安装")]),s._v(" "),a("h3",{attrs:{id:"gitlab简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab简介"}},[s._v("#")]),s._v(" Gitlab 简介")]),s._v(" "),a("p",[s._v("官网： https://about.gitlab.com/")]),s._v(" "),a("p",[s._v("GitLab 是一个用于仓库管理系统的开源项目，使用 Git 作为代码管理工具，并在此基础上搭建起来的 web 服务。")]),s._v(" "),a("p",[s._v("GitLab 和 GitHub 一样属于第三方基于 Git 开发的作品，免费且开源（基于 MIT 协议），与 Github 类似，可以注册用户，任意提交你的代码，添加 SSHKey 等等。不同的是，GitLab 是可以部署到自己的服务器上，数据库等一切信息都掌握在自己手上，适合团队内部协作开发，你总不可能把团队内部的智慧总放在别人的服务器上吧？简单来说可把 GitLab 看作个人版的 GitHub。")]),s._v(" "),a("h3",{attrs:{id:"gitlab安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab安装"}},[s._v("#")]),s._v(" Gitlab 安装")]),s._v(" "),a("p",[s._v("1. 安装相关依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum -y install policycoreutils openssh-server openssh-clients postfix\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2. 启动 ssh 服务 & 设置为开机启动")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl enable sshd && sudo systemctl start sshd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3. 设置 postfix 开机自启，并启动，postfix 支持 gitlab 发信功能")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl enable postfix && systemctl start postfix\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4. 开放 ssh 以及 http 服务，然后重新加载防火墙列表")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("firewall-cmd --add-service=ssh --permanent\nfirewall-cmd --add-service=http --permanent\nfirewall-cmd --reload\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("如果关闭防火墙就不需要做以上配置")])]),s._v(" "),a("p",[s._v("5. 下载 gitlab 包，并且安装"),a("br"),s._v("\n在线下载安装包：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm\n# 安装\nrpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("6. 修改 gitlab 配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vi /etc/gitlab/gitlab.rb\n# 修改gitlab访问地址和端口，默认为80，我们改为82\nexternal_url 'http://192.168.66.100:82'\nnginx['listen_port'] = 82\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ol",{attrs:{start:"7"}},[a("li",[s._v("重载配置及启动 gitlab")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("gitlab-ctl reconfigure\ngitlab-ctl restart\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("8. 把端口添加到防火墙")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("firewall-cmd --zone=public --add-port=82/tcp --permanent\nfirewall-cmd --reload\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("启动成功后，看到以下修改管理员 root 密码的页面，修改密码后，然后登录即可")]),s._v(" "),a("h2",{attrs:{id:"gitlab添加组、创建用户、创建项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab添加组、创建用户、创建项目"}},[s._v("#")]),s._v(" Gitlab 添加组、创建用户、创建项目")]),s._v(" "),a("p",[s._v("1. 创建组"),a("br"),s._v("\n使用管理员 root 创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理")]),s._v(" "),a("p",[s._v("2. 创建用户"),a("br"),s._v("\n创建用户的时候，可以选择 Regular 或 Admin 类型。创建完用户后，立即修改密码")]),s._v(" "),a("p",[s._v("3. 将用户添加到组中"),a("br"),s._v("\n选择某个用户组，进行 Members 管理组的成员")]),s._v(" "),a("p",[s._v("Gitlab 用户在组里面有 5 种不同权限：")]),s._v(" "),a("ul",[a("li",[s._v("Guest：可以创建 issue、发表评论，不能读写版本库 Reporter：可以克隆代码，不能提交，QA、PM 可以赋予这个权限")]),s._v(" "),a("li",[s._v("Developer：可以克隆代码、开发、提交、push，普通开发可以赋予这个权限")]),s._v(" "),a("li",[s._v("Maintainer：可以创建项目、添加 tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限")]),s._v(" "),a("li",[s._v("Owner：可以设置项目访问权限 - Visibility Level、删除项目、迁移项目、管理组成员，开发组组长可以赋予这个权限")])]),s._v(" "),a("p",[s._v("4. 在用户组中创建项目"),a("br"),s._v("\n以刚才创建的新用户身份登录到 Gitlab，然后在用户组中创建新的项目")]),s._v(" "),a("h2",{attrs:{id:"jenkins安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins安装"}},[s._v("#")]),s._v(" Jenkins 安装")]),s._v(" "),a("p",[s._v("1. 获取 jenkins 安装包，下载页面：http://mirrors.jenkins-ci.org/redhat/")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 国内环境不是那么好，下载要科学\nwget http://mirrors.jenkins-ci.org/redhat/jenkins-2.190.3-1.1.noarch.rpm\n# 安装\nrpm -ivh jenkins-2.190.3-1.1.noarch.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("2. 修改 Jenkins 配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('vim /etc/sysconfig/jenkins\n# 修改内容如下\n# 能执行jenkins的用户权限\nJENKINS_USER="root" \n# 页面访问端口\nJENKINS_PORT="7777" \n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("3. 启动 Jenkins")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl start jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("报错"),a("br"),s._v("\n Starting Jenkins bash: /usr/bin/java: 没有那个文件或目录"),a("br"),s._v("\n Failed to start LSB: Jenkins Automation Server."),a("br"),s._v("\n 是因为 jenkins 内部自己配置了 java 地址，需要改一下。"),a("br"),s._v("\nvim /etc/init.d/jenkins"),a("br"),s._v("\n/usr/bin/java 找到，并改成自己的 java 地址，我的是 /opt/software/java8/jre/bin/java，注意这里找的是 jre 的。"),a("br"),s._v("\n执行 systemctl daemon-reload，在执行 systemctl start jenkins")])]),s._v(" "),a("blockquote",[a("p",[s._v("最新版本 Jenkins 2.346.1 和之前版本还是有不一样的地方，这里只说几个 Jenkins 2.346.1  遇到的报错："),a("br"),s._v('\n1 Aug 16 14:19:14 host-10-240-30-93 jenkins [31531]: jenkins: failed to find a valid Java installation 这种报错一直说是没安装 JAVA，但是我明明按照以上方式都配置过了，最终解决方式就是编辑 vim /usr/lib/systemd/system/jenkins.service 文件，找到被注释的 Environment="JAVA_HOME="，把自己的 JAVA 路径写上，如 /opt/software/jdk'),a("br"),s._v('\n2 Aug 16 14:26:42 host-10-240-30-93 jenkins [10782]: java.net.BindException: Address already in use 你会发现在 vim /etc/sysconfig/jenkins 文件都改过了，但还是端口占用，依然需要修改 vim /usr/lib/systemd/system/jenkins.service 文件，并编辑 Environment="JENKINS_PORT=7777" 改成自己需要的端口'),a("br"),s._v("\n 3  Aug 16 14:28:37 host-10-240-30-93 jenkins [20925]: Caused: java.io.IOException: Failed to start Jetty 检查所有配置包括 /etc/sysconfig/jenkins 和 /usr/lib/systemd/system/jenkins.service，却报配置正确"),a("br"),s._v('\n 4 Aug 16 14:44:10 host-10-240-30-93 jenkins [12516]: jenkins: invalid Java version: java version "17.0.3.1" 2022-04-22 LTS JAVA 版本过高或过低导致，我用 java17 或 11 直接不行，换成 8 就好了')])]),s._v(" "),a("p",[s._v("4. 打开浏览器访问"),a("br"),s._v("\n http://192.168.66.101:7777")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：本服务器把防火墙关闭了，如果开启防火墙，需要在防火墙添加端口")])]),s._v(" "),a("p",[s._v("5. 获取并输入 admin 账户密码")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cat /var/lib/jenkins/secrets/initialAdminPassword\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("6. 添加一个管理员账户，并进入 Jenkins 后台")]),s._v(" "),a("p",[s._v("7. 跳过插件安装"),a("br"),s._v("\n因为 Jenkins 插件需要连接默认官网下载，速度非常慢，而且经过会失败，所以我们暂时先跳过插件安装")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img_1.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/502/img_1.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/503/img_1.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/504/img_1.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/505/img_1.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"jenkins插件管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins插件管理"}},[s._v("#")]),s._v(" jenkins 插件管理")]),s._v(" "),a("p",[s._v("Jenkins 本身不提供很多功能，我们可以通过使用插件来满足我们的使用。例如从 Gitlab 拉取代码，使用 Maven 构建项目等功能需要依靠插件完成。接下来演示如何下载插件。")]),s._v(" "),a("h3",{attrs:{id:"修改jenkins插件下载地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改jenkins插件下载地址"}},[s._v("#")]),s._v(" 修改 Jenkins 插件下载地址")]),s._v(" "),a("p",[s._v("Jenkins 国外官方插件地址下载速度非常慢，所以可以修改为国内插件地址：Jenkins->Manage Jenkins->Manage Plugins，点击 Available")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/506/img_1.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/507/img_1.png",alt:""}})]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl restart jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/508/img_1.png",alt:""}})]),s._v(" "),a("p",[s._v("此时我们可以进入 /var/lib/jenkins/updates，看到有个 default.json，这个文件里面是所有插件的地址，这里面的地址目前全是国外的地址，可以用以下命令进行替换到国内地址。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sed -i 's/http:\\/\\/updates.jenkinsci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g' default.json && sed -i 's/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g' default.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("最后，Manage Plugins 点击 Advanced，把 Update Site 改为国内插件下载地址")]),s._v(" "),a("blockquote",[a("p",[s._v("https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img_9.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img_10.png",alt:""}})]),s._v(" "),a("p",[s._v("重启 jenkins ，在访问路径后面键入 restart 即可。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://192.168.81.102:7777/restart\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("重启好后，我们进行对 jenkins 进行汉化。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img_11.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/jenkins/501/img_12.png",alt:""}})]),s._v(" "),a("blockquote",[a("p",[s._v("jenkins 版本更新太快，包括核心库也会更新，大家可以放心更新，不用怕，最多就是起不来重装。")])]),s._v(" "),a("h2",{attrs:{id:"jenkins-卸载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-卸载"}},[s._v("#")]),s._v(" Jenkins 卸载")]),s._v(" "),a("p",[s._v("先停止 Jenkins 的运行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 方式一\nsystemctl stop jenkins\n# 方式二\nservice jenkins stop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("找到所有跟 Jenkins 相关的包")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rpm -qc jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("卸载相关包")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rpm -e jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("检查是否卸载成功")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("rpm -ql jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("删除参与文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("find / -iname jenkins | xargs -n 1000 rm -rf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);e.default=n.exports}}]);