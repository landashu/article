(window.webpackJsonp=window.webpackJsonp||[]).push([[129],{606:function(s,a,e){"use strict";e.r(a);var n=e(41),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("blockquote",[e("p",[s._v("本文及后续所有文章都以 21.7.3.14-2 做为版本讲解和入门学习")])]),s._v(" "),e("p",[s._v("ClickHouse 的 SQL 优化规则是基于 RBO (Rule Based Optimization)，下面是一些优化规则")]),s._v(" "),e("h2",{attrs:{id:"上传测试用例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#上传测试用例"}},[s._v("#")]),s._v(" 上传测试用例")]),s._v(" "),e("p",[s._v("将官方提供的测试集 visits_v1.tar 和 hits_v1.tar 下载并上传到虚拟机，解压到 clickhouse 数据路径下。"),e("a",{attrs:{href:"https://clickhouse.com/docs/en/getting-started/example-datasets/metrica/",target:"_blank",rel:"noopener noreferrer"}},[s._v("数据下载地址"),e("OutboundLink")],1),s._v(" ，当然官方也可以在线的方式，不需要下载就测试 sql 语句查询。"),e("a",{attrs:{href:"https://play.clickhouse.com/?file=welcome",target:"_blank",rel:"noopener noreferrer"}},[s._v("在线地址"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压到 clickhouse 数据路径")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -xvf hits_v1.tar -C /var/lib/clickhouse\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -xvf visits_v1.tar -C /var/lib/clickhouse\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改所属用户")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R clickhouse:clickhouse /var/lib/clickhouse/data/datasets\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R clickhouse:clickhouse /var/lib/clickhouse/metadata/datasets\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("重启 clickhouse-server，执行查询")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("clickhouse-client --query "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SELECT COUNT(*) FROM datasets.hits_v1"')]),s._v("\nclickhouse-client --query "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SELECT COUNT(*) FROM datasets.visits_v1"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("注意：官方的 tar 包，包含了建库、建表语句、数据内容，这种方式不需要手动建库、建表，最方便。hits_v1 表有 130 多个字段，880 多万条数据，visits_v1 表有 180 多个字段，160 多万条数据。")]),s._v(" "),e("h2",{attrs:{id:"count-优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#count-优化"}},[s._v("#")]),s._v(" COUNT 优化")]),s._v(" "),e("p",[s._v("在调用 count 函数时，如果使用的是 count () 或者 count (*)，且没有 where 条件，则会直接使用 system.tables 的 total_rows。以下语句可以使用 explain plan select..  来看变化")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#  默认会查询 count 文件直接拿到数据\nselect count() from hits_v1\n# 会转变成 count()\nselect count(*) from hits_v1\n# 会转变成 count()\nselect count(1) from hits_v1\n# 只要不是写具体的字段不会触发冲洗计算\nselect count(UserID) from hits_v1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h2",{attrs:{id:"消除子查询重复字段或无用字段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消除子查询重复字段或无用字段"}},[s._v("#")]),s._v(" 消除子查询重复字段或无用字段")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 实际查询语句\nEXPLAIN SYNTAX SELECT\n a.UserID,\n b.VisitID,\n a.URL,\n b.UserID\n FROM\n hits_v1 AS a\n LEFT JOIN (\n SELECT\n UserID,\n UserID as HaHa,\n VisitID\n FROM visits_v1) AS b\n USING (UserID)\n limit 3;\n\n# 返回优化语句\nSELECT\n UserID,\n VisitID,\n URL,\n b.UserID\nFROM hits_v1 AS a\nALL LEFT JOIN\n(\n SELECT\n UserID,\n VisitID\n FROM visits_v1\n) AS b USING (UserID)\nLIMIT 3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br")])]),e("h2",{attrs:{id:"谓词下推"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#谓词下推"}},[s._v("#")]),s._v(" 谓词下推")]),s._v(" "),e("p",[s._v("当 group by 有 having 子句，但是没有 with cube、with rollup 或者 with totals 修饰的时候，having 过滤会下推到 where 提前过滤。例如下面的查询，having name 变成了 where name，在 group by 之前过滤。")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT UserID FROM hits_v1 GROUP BY UserID HAVING UserID ='8585742290196126178';\n\n# 返回优化语句\nSELECT UserID FROM hits_v1 WHERE UserID = '8585742290196126178' GROUP BY UserID\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT * FROM ( SELECT UserID FROM visits_v1 ) WHERE UserID = '8585742290196126178'\n\n# 返回优化后的语句\nSELECT UserID FROM ( SELECT UserID FROM visits_v1 WHERE UserID = '8585742290196126178' ) WHERE UserID = '8585742290196126178'\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT * FROM ( \n  SELECT * FROM ( SELECT UserID FROM visits_v1)  \n    UNION ALL \n  SELECT *   FROM ( SELECT UserID FROM visits_v1) \n) WHERE UserID = '8585742290196126178'\n\n# 优化后的\nSELECT UserID FROM ( \n  SELECT UserID FROM ( \n    SELECT UserID FROM visits_v1 WHERE UserID = '8585742290196126178' \n  ) WHERE UserID = '8585742290196126178' \n    UNION ALL \n  SELECT UserID FROM ( \n    SELECT UserID FROM visits_v1 WHERE UserID = '8585742290196126178'  \n  ) WHERE UserID = '8585742290196126178' \n) WHERE UserID = '8585742290196126178'\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h2",{attrs:{id:"聚合计算外推"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#聚合计算外推"}},[s._v("#")]),s._v(" 聚合计算外推")]),s._v(" "),e("p",[s._v("聚合函数内的计算，会外推")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT sum(UserID * 2) FROM visits_v1\n\n# 优化后\nSELECT sum(UserID) * 2 FROM visits_v1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"聚合函数消除"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#聚合函数消除"}},[s._v("#")]),s._v(" 聚合函数消除")]),s._v(" "),e("p",[s._v("如果对聚合键，也就是 group by key 使用 min、max、any 聚合函数，则将函数消除")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT sum(UserID * 2), max(VisitID), max(UserID) FROM visits_v1 GROUP BY UserID\n\n# 优化后\nSELECT sum(UserID) * 2, max(VisitID), UserID FROM visits_v1 GROUP BY UserID\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"删除重复的-order-by-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除重复的-order-by-key"}},[s._v("#")]),s._v(" 删除重复的 order by key")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT * FROM visits_v1 ORDER BY  UserID ASC, UserID ASC, VisitID ASC,VisitID ASC\n\n# 优化后\nselect …… FROM visits_v1 ORDER BY UserID ASC,VisitID ASC\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"删除重复的-limit-by-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除重复的-limit-by-key"}},[s._v("#")]),s._v(" 删除重复的 limit by key")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT * FROM visits_v1 LIMIT 3 BY VisitID, VisitID LIMIT 10\n\n# 返回优化后的语句：\nselect …… FROM visits_v1 LIMIT 3 BY VisitID LIMIT 10\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"删除重复的-using-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除重复的-using-key"}},[s._v("#")]),s._v(" 删除重复的 USING Key")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT a.UserID, a.UserID, b.VisitID, a.URL, b.UserID FROM hits_v1 AS a \nLEFT JOIN visits_v1 AS b USING (UserID, UserID)\n\n# 返回优化后的语句：\nSELECT  UserID, UserID, VisitID, URL, b.UserID FROM hits_v1 AS a ALL LEFT JOIN visits_v1 AS b USING (UserID)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h2",{attrs:{id:"标量替换"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#标量替换"}},[s._v("#")]),s._v(" 标量替换")]),s._v(" "),e("p",[s._v("如果子查询只返回一行数据，在被引用的时候用标量替换，例如下面语句中的 total_disk_usage 字段")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX WITH (  SELECT sum(bytes) FROM system.parts WHERE active ) AS total_disk_usage SELECT\n (sum(bytes) / total_disk_usage) * 100 AS table_disk_usage, \ntable FROM system.parts GROUP BY table ORDER BY table_disk_usage DESC LIMIT 10;\n\n# 返回优化后的语句\nWITH CAST(0, 'UInt64') AS total_disk_usage SELECT  (sum(bytes) / total_disk_usage) * 100 AS table_disk_usage,\ntable FROM system.parts GROUP BY table ORDER BY table_disk_usage DESC LIMIT 10\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h2",{attrs:{id:"三元运算优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三元运算优化"}},[s._v("#")]),s._v(" 三元运算优化")]),s._v(" "),e("p",[s._v("如果开启了 optimize_if_chain_to_multiif 参数，三元运算符会被替换成 multiIf 函数")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 查询语句\nEXPLAIN SYNTAX SELECT number = 1 ? 'hello' : (number = 2 ? 'world' : 'atguigu') FROM numbers(10) \nsettings optimize_if_chain_to_multiif = 1;\n\n# 返回优化后的语句：\nSELECT multiIf(number = 1, 'hello', number = 2, 'world', 'atguigu') FROM numbers(10)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);