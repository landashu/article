(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{598:function(s,a,e){"use strict";e.r(a);var t=e(41),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("blockquote",[e("p",[s._v("本文及后续所有文章都以 21.7.3.14-2 做为版本讲解和入门学习")])]),s._v(" "),e("h2",{attrs:{id:"监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控"}},[s._v("#")]),s._v(" 监控")]),s._v(" "),e("p",[s._v("ClickHouse 运行时会将一些个自身的运行状态记录到众多系统表中 (system.*)。所以我们对于 CH 自身的一些运行指标的监控数据，也主要来自这些系统表。")]),s._v(" "),e("p",[s._v("但是直接查询这些系统表会有一些不足之处：")]),s._v(" "),e("ul",[e("li",[s._v("这种方式太过底层，不够直观，我们还需要在此之上实现可视化展示；")]),s._v(" "),e("li",[s._v("系统表只记录了 CH 自己的运行指标，有些时候我们需要外部系统的指标进行关联分析，例如 ZooKeeper、服务器 CPU、IO 等等。")])]),s._v(" "),e("p",[s._v("现在 Prometheus + Grafana 的组合比较流行，安装简单易上手，可以集成很多框架，包括服务器的负载，其中 Prometheus 负责收集各类系统的运行指标；Grafana 负责可视化的部分。")]),s._v(" "),e("p",[s._v("ClickHouse 从 v20.1.2.4 开始，内置了对接 Prometheus 的功能，配置的方式也很简单，可以将其作为 Prometheus 的 Endpoint 服务，从而自动的将 metrics 、 events 和 asynchronous_metrics 三张系统的表的数据发送给 Prometheus。")]),s._v(" "),e("div",{staticClass:"language-clickhouse line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("select * from system.metrics;\nselect * from system.events;\nselect * from system.asynchronous_metrics;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("blockquote",[e("p",[s._v("具体的监控配置可以见  链接：https://pan.baidu.com/s/1KdVZ9h-h5x-HjzBLsadaXA  提取码：tffo")])]),s._v(" "),e("h2",{attrs:{id:"备份"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#备份"}},[s._v("#")]),s._v(" 备份")]),s._v(" "),e("p",[s._v("ClickHouse 允许使用 ALTER TABLE ... FREEZE PARTITION ... 查询以创建表分区的本地副本。这是利用硬链接 (hardlink) 到 /var/lib/clickhouse/shadow/ 文件夹中实现的，所以它通常不会因为旧数据而占用额外的磁盘空间。 创建的文件副本不由 ClickHouse 服务器处理，所以不需要任何额外的外部系统就有一个简单的备份。防止硬件问题，最好将它们远程复制到另一个位置，然后删除本地副本。"),e("a",{attrs:{href:"https://clickhouse.tech/docs/en/operations/backup/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方地址"),e("OutboundLink")],1)]),s._v(" "),e("h3",{attrs:{id:"创建备份路径"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建备份路径"}},[s._v("#")]),s._v(" 创建备份路径")]),s._v(" "),e("p",[s._v("创建用于存放备份数据的目录 shadow，shadow 只能相当于一个中转站。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/lib/clickhouse/shadow/\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" clickhouse:clickhouse shadow\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"执行备份命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#执行备份命令"}},[s._v("#")]),s._v(" 执行备份命令")]),s._v(" "),e("p",[s._v("在外部执行命令，冻结的表依然可以使用，不会导致无法使用的。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -n "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'alter table 表名 freeze'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"将备份数据保存到其他路径"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#将备份数据保存到其他路径"}},[s._v("#")]),s._v(" 将备份数据保存到其他路径")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建备份存储路径")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/lib/clickhouse/backup/\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#拷贝数据到备份路径")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -r /var/lib/clickhouse/shadow/ /var/lib/clickhouse/backup/表名-时间\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改备份文件的所有权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R clickhouse:clickhouse backup/\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为下次备份准备，删除 shadow 下的数据")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /var/lib/clickhouse/shadow/*\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"恢复数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#恢复数据"}},[s._v("#")]),s._v(" 恢复数据")]),s._v(" "),e("p",[s._v("可以把之前的表先删掉，然后重新建表")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'drop table 表名'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("恢复")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -rl /var/lib/clickhouse/backup/表名-时间/1/store/一串uuid/* data/default/表名/detached/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("ClickHouse 使用文件系统硬链接来实现即时备份，而不会导致 ClickHouse 服务停机（或锁定）。这些硬链接可以进一步用于有效的备份存储。在支持硬链接的文件系统（例如本地文件系统或 NFS）上，将 cp 与 -l 标志一起使用（或将 rsync 与 –hard-links 和 –numeric-ids 标志一起使用）以避免复制数据。")]),s._v(" "),e("p",[s._v("执行 attach")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 整张表恢复")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'alter table 表名 attach'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 按分区恢复")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'alter table 表名 attach partition 20200601'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" clickhouse-client\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h2",{attrs:{id:"使用-clickhouse-backup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-clickhouse-backup"}},[s._v("#")]),s._v(" 使用 clickhouse-backup")]),s._v(" "),e("p",[s._v("上面的过程，我们可以使用 Clickhouse 的备份工具 clickhouse-backup 帮我们自动化实现。"),e("a",{attrs:{href:"https://github.com/AlexAkulov/clickhouse-backup/",target:"_blank",rel:"noopener noreferrer"}},[s._v("工具地址"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/AlexAkulov/clickhouse-backup/releases/download/v1.2.1/clickhouse-backup-1.2.1-1.x86_64.rpm\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh clickhouse-backup-1.0.0-1.x86_64.rpm\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看命令")]),s._v("\nclickhouse-backup "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示要备份的表")]),s._v("\n clickhouse-backup tables\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建备份")]),s._v("\nclickhouse-backup create\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份到远程")]),s._v("\nclickhouse-backup upload\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建并备份到远程机器")]),s._v("\nclickhouse-backup create_remote\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 恢复")]),s._v("\nclickhouse-backup restore 备份的文件\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看现有的本地备份")]),s._v("\nclickhouse-backup list\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("备份存储在中 /var/lib/clickhouse/backup/BACKUPNAME。备份名称默认为时间戳，但是可以选择使用–name 标志指定备份名称。备份包含两个目录：一个 “metadata” 目录，其中包含重新创建架构所需的 DDL SQL 语句；以及一个 “shadow” 目录，其中包含作为 ALTER TABLE ...FREEZE 操作结果的数据。")])])}),[],!1,null,null,null);a.default=n.exports}}]);