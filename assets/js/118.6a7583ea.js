(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{595:function(s,t,a){"use strict";a.r(t);var e=a(41),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("blockquote",[a("p",[s._v("本文及后续所有文章都以 21.7.3.14-2 做为版本讲解和入门学习")])]),s._v(" "),a("p",[s._v("ClickHouse 是俄罗斯的 Yandex 于 2016 年开源的 "),a("strong",[s._v("列式存储数据库 (DBMS)")]),s._v("，使用 C++ 语言编写，主要用于 "),a("strong",[s._v("在线分析处理查询 (OLAP)")]),s._v("，能够使用 SQL 查询实时生成分析数据报告。")]),s._v(" "),a("h2",{attrs:{id:"列式存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#列式存储"}},[s._v("#")]),s._v(" 列式存储")]),s._v(" "),a("p",[s._v("行存储以下表为例")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("ID")]),s._v(" "),a("th",[s._v("NAME")]),s._v(" "),a("th",[s._v("AGE")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("1")]),s._v(" "),a("td",[s._v("张三")]),s._v(" "),a("td",[s._v("18")])]),s._v(" "),a("tr",[a("td",[s._v("2")]),s._v(" "),a("td",[s._v("李四")]),s._v(" "),a("td",[s._v("22")])]),s._v(" "),a("tr",[a("td",[s._v("3")]),s._v(" "),a("td",[s._v("王五")]),s._v(" "),a("td",[s._v("38")])])])]),s._v(" "),a("p",[s._v("采用行存储时，数据在磁盘上的组织结构为")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("1")]),s._v(" "),a("th",[s._v("张三")]),s._v(" "),a("th",[s._v("18")]),s._v(" "),a("th",[s._v("2")]),s._v(" "),a("th",[s._v("李四")]),s._v(" "),a("th",[s._v("22")]),s._v(" "),a("th",[s._v("3")]),s._v(" "),a("th",[s._v("王五")]),s._v(" "),a("th",[s._v("34")])])])]),s._v(" "),a("p",[s._v("好处是想查某个人所有的属性时，可以通过一次磁盘查找加顺序读取就可以。但是当想查所有人的年龄时，需要不停的查找，或者全表扫描才行，遍历的很多数据都是不需要的。")]),s._v(" "),a("p",[s._v("采用列存储时，数据在磁盘上的组织结构为")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("1")]),s._v(" "),a("th",[s._v("2")]),s._v(" "),a("th",[s._v("3")]),s._v(" "),a("th",[s._v("张三")]),s._v(" "),a("th",[s._v("李四")]),s._v(" "),a("th",[s._v("王五")]),s._v(" "),a("th",[s._v("18")]),s._v(" "),a("th",[s._v("22")]),s._v(" "),a("th",[s._v("34")])])])]),s._v(" "),a("p",[s._v("这时相查所有人的年龄只需要把年龄那一列拿出来就可以了。")]),s._v(" "),a("p",[s._v("列式存储的好处：")]),s._v(" "),a("ul",[a("li",[s._v("对于列的聚合，计数，求和等统计操作由于行式存储")]),s._v(" "),a("li",[s._v("由于某一列的数据类型都是相同的，针对于数据存储更容易进行数据压缩，每一列选择更优的数据压缩算法，大大提高了数据的压缩比重。")]),s._v(" "),a("li",[s._v("由于数据压缩比更好，一方面节省了磁盘空间，另一方面对于 cache 也有了更大的发挥空间。")])]),s._v(" "),a("h3",{attrs:{id:"dbms"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dbms"}},[s._v("#")]),s._v(" DBMS")]),s._v(" "),a("p",[s._v("几乎覆盖了标准 SQL 的大部分语法，包括 DDL 和 DML，以及配套的各种函数，用户管理及权限管理，数据的备份与恢复。")]),s._v(" "),a("h3",{attrs:{id:"多样化引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多样化引擎"}},[s._v("#")]),s._v(" 多样化引擎")]),s._v(" "),a("p",[s._v("ClickHouse 和 MySql 类似，把表级的存储引擎插件优化，根据表的不同需求可以设定不同的存储引擎。目前包括"),a("strong",[s._v("合并树 (Merge Tree)")]),s._v("、日志、接口和其他四大类 20 多种引擎。")]),s._v(" "),a("h3",{attrs:{id:"高吞吐写入能力"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高吞吐写入能力"}},[s._v("#")]),s._v(" 高吞吐写入能力")]),s._v(" "),a("p",[s._v("ClickHouse 采用类 LSM Tress (HBASE 也是) 的结构，数据写入后定期在后台 Compaction。通过类似 LSM Tree 的结构，ClickHouse 在数据导入时全部是顺序 append 写入，写入后数据段不可更改，在后台 compaction 时也是多个段 merge sort 后循序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力，即便在 HDD 上也有着优异的写入性能。")]),s._v(" "),a("p",[s._v("官方公开 benchmark 测试显示能够达到 50MB-200MB/s 的写入吞吐能力，按照每行 100Byte 估算，大约相当于 50W-200W 条 /s 的写入速度。")]),s._v(" "),a("h3",{attrs:{id:"数据分区与线程级并行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据分区与线程级并行"}},[s._v("#")]),s._v(" 数据分区与线程级并行")]),s._v(" "),a("p",[s._v("ClickHouse 将数据划分为多个 partition，每个 partition 再进一步划分为多个 index granularity (索引粒度)，然后通过多个 CPU 核心分别处理其中的一部分来实现并行数据处理。在这种设计下，"),a("strong",[s._v("单条 Query 就能利用整机所有 CPU")]),s._v("。极致的并行处理能力，极大的降低了查询延时。")]),s._v(" "),a("p",[s._v("所以，ClickHouse 即使对于大量数据的查询也能够化整为零平行处理。但是有一个弊端就是对于单条查询使用多 CPU，就不利于同时并发多条查询。所以对于高 qps 的查询业务，ClickHouse 并不是强项。")]),s._v(" "),a("h2",{attrs:{id:"性能对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能对比"}},[s._v("#")]),s._v(" 性能对比")]),s._v(" "),a("h3",{attrs:{id:"单表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单表"}},[s._v("#")]),s._v(" 单表")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/ck/1/img.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"关联查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关联查询"}},[s._v("#")]),s._v(" 关联查询")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/ck/1/img_1.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"结论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),a("p",[s._v("ClickHouse 像很多 OLAP 数据库一样，单表查询速度优于关联查询，而且 ClickHouse 的两者差距更为明显。")]),s._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("h3",{attrs:{id:"centos-取消打开文件数限制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#centos-取消打开文件数限制"}},[s._v("#")]),s._v(" CentOS 取消打开文件数限制")]),s._v(" "),a("ol",[a("li",[s._v("ulimit -a 查看配置信息")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ulimit -a")]),s._v("\ncore "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ndata seg size           "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nscheduling priority             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" size               "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("blocks, -f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\npending signals                 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31118")]),s._v("\nmax locked memory       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\nmax memory size         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" files                      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\npipe size            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" bytes, -p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\nPOSIX message queues     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes, -q"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("819200")]),s._v("\nreal-time priority              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nstack size              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v("\ncpu "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds, -t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\nmax user processes              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-u"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31118")]),s._v("\nvirtual memory          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kbytes, -v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" locks                      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" unlimited\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("其中我们最关心的是 open files 和 max user processes，max user processes 意思是当前用户最大能打开多少个进程。")]),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[s._v("在服务机上的 /etc/security/limits.conf 文件的末尾加入以下内容")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("* soft nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n* hard nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n* soft nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n* hard nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("一共四列，第一列代表用户组，* 代表所有用户组，要设定特定的用户可以把 * 替换为 用户名 @用户组；第二列 soft 和 hard，意思就是 当前 和 最大 (上限)，注意 当前要 <= 最大；第三列 nofile 和 nproc ，即 打开文件数 和 进程数；")]),s._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[s._v("在服务机上的 /etc/security/limits.d/20-nproc.conf 文件的末尾加入以下内容")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("* soft nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n* hard nofile "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n* soft nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n* hard nproc "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("该路径的文件会覆盖 第 2 步骤的配置，所以建议在该文件也配置。"),a("br"),s._v("\n以上配置生效，需要重启最好，不重启可以用以下命令。有没有生效可以通过 ulimit -a 来查看")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -n 或 -u 在 ulimit -a 中可以看到")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改 open files")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改 max user processes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -u "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[a("p",[s._v("如果是集群的话，其他服务器也需要同步以上配置")])]),s._v(" "),a("li",[a("p",[s._v("提前创建号 clickhouse 用户和组，并尝试登录没有问题")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该命令默认会添加一个 clickhouse 组")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" clickhouse -d /home/users/clickhouse\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改clickhouse用户登录密码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v(" clickhouse\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"安装依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖"}},[s._v("#")]),s._v(" 安装依赖")]),s._v(" "),a("ol",[a("li",[s._v("yum install -y libtool")]),s._v(" "),a("li",[s._v("yum install -y *unixODBC*")]),s._v(" "),a("li",[s._v("其他服务器也是一样的步骤")])]),s._v(" "),a("h3",{attrs:{id:"centos-取消-selinux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#centos-取消-selinux"}},[s._v("#")]),s._v(" CentOS 取消 SELINUX")]),s._v(" "),a("ol",[a("li",[s._v("修改 /etc/selinux/config 中的 SELINUX=disabled")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/selinux/config\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SELINUX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("disabled\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("SELINUX 是 linux 内核的安全软件，改了之后需要重启，否则不会生效。当然也可以让其临时生效，setenforce 0（0 关闭，1 开启 但是想开的话必须先重启），执行后可以通过 getenforce 查看状态。"),a("br"),s._v("\n2. 其他服务器同步操作")]),s._v(" "),a("h3",{attrs:{id:"单机安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单机安装"}},[s._v("#")]),s._v(" 单机安装")]),s._v(" "),a("p",[s._v("官网地址：https://clickhouse.com/"),a("br"),s._v("\n 下载地址：https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/")]),s._v(" "),a("p",[s._v("下载的话注意要下载 4 个包，clickhouse-client、clickhouse-common-static、clickhouse-common-dbg、clickhouse-server。其中版本的话 20.5 后支持 final 多线程，20.6.3 后支持 explain 执行计划，20.8 出了实时同步 Mysql。"),a("strong",[s._v("clickhouse 端口默认 9000")])]),s._v(" "),a("p",[s._v("linu 下载可以通过以下命令直接下载。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/clickhouse-client-21.7.3.14-2.noarch.rpm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/clickhouse-common-static-21.7.3.14-2.x86_64.rpm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/clickhouse-common-static-dbg-21.7.3.14-2.x86_64.rpm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://repo.yandex.ru/clickhouse/rpm/stable/x86_64/clickhouse-server-21.7.3.14-2.noarch.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如果下载的文件在该文件夹下没有其他文件，可以使用以下命令直接安装，如果还有其他 rpm 文件，则把 * 就换成所对应的文件。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh *.rpm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在安装过程中新版本会让你设置一个密码，默认账户就是 default，不设置可以直接回车。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("Enter password "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" default user: \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("安装完成后可以通过如下命令来确定是否安装成功")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -qa"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" clickhouse\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("安装好的配置文件会放在 /etc/ 下，而 lib 数据会放在 /var/lib/clickhouse，日志会在 /var/log/clickhouse，命令会在 usr/bin/ 下。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("bin/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   /usr/bin/\nconf/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  /etc/clickhouse-server/\nlib/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   /var/lib/clickhouse\nlog/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   /var/log/clickhouse\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("安装成功的 clickhouse 会自己创建一个 clickhouse 用户，如果你是用非 root 用户访问，可能会无法访问以上目录。")]),s._v(" "),a("p",[s._v("进入 /etc/clickhouse-server/ 可以看到有 4 个文件")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("config.d\nconfig.xml\nusers.d\nusers.xml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("其中 config.d 和 users.d 是文件夹，里面放的是一些默认配置。最核心的还是两个 xml 文件，config.xml 是通用的服务端配置，users.xml 为参数配置。")]),s._v(" "),a("p",[s._v("修改 config.xml")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 默认本机访问，允许其他服务访问可以使用 :: ，意思不对IP做限制--\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("listen_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("::"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("listen_host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 数据文件路径 --\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("/var/lib/clickhouse/"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 日志文件路径 --\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("/var/log/clickhouse-server/clickhouse-server.log"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("\x3c!-- 修改时区 --\x3e")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("timezone")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("Asia/Shanghai"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("timezone")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("blockquote",[a("p",[s._v("如果修改报错后报 E45: 'readonly' option is set (add ! to override)，可以换成 wq!，就可以了。")])]),s._v(" "),a("p",[s._v("启动 server")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动方式1,这种方式不会加载/etc下的配置文件，垃圾")]),s._v("\nclickhouse status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("start,stop,restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动方式2（比较好），但是不是后台启动，自己 nohup 启动就好")]),s._v("\nclickhouse-server  --config-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/clickhouse-server/config.xml \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("clickhouse-server  --config-file=/etc/clickhouse-server/config.xml  可能由于权限不足原因启动不了，此时要切换 clickhouse 用户启动，但是 su clickhouse 可能无效，可以给 clickhouse 添加 用户目录 和 /bin/bash 权限，"),a("a",{attrs:{href:"https://www.jianshu.com/p/2f36102910dc",target:"_blank",rel:"noopener noreferrer"}},[s._v("确保 su clickhouse 没有问题"),a("OutboundLink")],1),s._v("，然后通过命令启动。如果命令启动报错，大部分还是文件权限原因，如  Access to file denied: /var/log/clickhouse-server/clickhouse-server.log ，直接 chown clickhouse  Access to file denied: /var/log/clickhouse-server/clickhouse-server.log 修改文件权限，再次执行就好了。")])]),s._v(" "),a("p",[s._v("连接 server")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("clickhouse-client -m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("-m 以；号为语句的结束")]),s._v(" "),a("li",[s._v("-h 指定访问的 IP")]),s._v(" "),a("li",[s._v("-p 指定访问的端口")]),s._v(" "),a("li",[s._v('--query "" 执行查询语句')]),s._v(" "),a("li",[s._v("-u [--user] arg (=default) 指定用户，默认就是 default")]),s._v(" "),a("li",[s._v("--password 如果设置了密码可以加上该参数")])]),s._v(" "),a("p",[s._v("关闭开机自启动设置")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl disable clickhouse-server\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("如果机器缓存占用多没释放，可以使用 echo 3 > /proc/sys/vm/drop_caches")])])])}),[],!1,null,null,null);t.default=n.exports}}]);