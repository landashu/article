<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 高可用MGR(一) 理论 | 技术博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="人民万岁">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/1.styles.014bf4fe.css" as="style"><link rel="preload" href="/assets/js/app.12ef6c1f.js" as="script"><link rel="preload" href="/assets/js/11.5871899e.js" as="script"><link rel="preload" href="/assets/js/98.70766fd8.js" as="script">
    <link rel="stylesheet" href="/assets/css/1.styles.014bf4fe.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo1.png" alt="技术博客" class="logo"> <span class="site-name can-hide">技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><!----> <span class="title" style="display:;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/base/1/" class="nav-link">JAVA</a></li><li class="dropdown-item"><!----> <a href="/language/cj/1/" class="nav-link">仓颉</a></li><li class="dropdown-item"><!----> <a href="/language/mode/1/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><!----> <span class="title" style="display:;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frame/spring/200/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/frame/mybatis/300/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/frame/maven/2300/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/frame/git/1/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kafka/1400/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/rabbitmq/1/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/rocketmq/1/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/redis/1600/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/nginx/1/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/es/1800/" class="nav-link">Elasticsearch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/700/" class="nav-link">Hadoop</a></li><li class="dropdown-item"><!----> <a href="/clickhouse/800/" class="nav-link">ClickHouse</a></li><li class="dropdown-item"><!----> <a href="/hbase/900/" class="nav-link">Hbase</a></li><li class="dropdown-item"><!----> <a href="/hive/1000/" class="nav-link">Hive</a></li><li class="dropdown-item"><!----> <a href="/flume/1100/" class="nav-link">Flume</a></li><li class="dropdown-item"><!----> <a href="/flink/1200/" class="nav-link">Flink</a></li><li class="dropdown-item"><!----> <a href="/mysql/1300/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/mongodb/1800/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><!----> <span class="title" style="display:;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/1900/" class="nav-link">VUE3</a></li><li class="dropdown-item"><!----> <a href="/wx/2000/" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><!----> <span class="title" style="display:;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/2300/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/docker/400/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/jenkins/500/" class="nav-link">Jenkins</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/600/" class="nav-link">Kubernetes</a></li></ul></div></div> <a href="https://github.com/landashu?tab=repositories" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="语言" class="dropdown-title"><!----> <span class="title" style="display:;">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/base/1/" class="nav-link">JAVA</a></li><li class="dropdown-item"><!----> <a href="/language/cj/1/" class="nav-link">仓颉</a></li><li class="dropdown-item"><!----> <a href="/language/mode/1/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><!----> <span class="title" style="display:;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frame/spring/200/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/frame/mybatis/300/" class="nav-link">Mybatis</a></li><li class="dropdown-item"><!----> <a href="/frame/maven/2300/" class="nav-link">Maven</a></li><li class="dropdown-item"><!----> <a href="/frame/git/1/" class="nav-link">Git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title" style="display:;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kafka/1400/" class="nav-link">Kafka</a></li><li class="dropdown-item"><!----> <a href="/rabbitmq/1/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/rocketmq/1/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/redis/1600/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/nginx/1/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/es/1800/" class="nav-link">Elasticsearch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><!----> <span class="title" style="display:;">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/700/" class="nav-link">Hadoop</a></li><li class="dropdown-item"><!----> <a href="/clickhouse/800/" class="nav-link">ClickHouse</a></li><li class="dropdown-item"><!----> <a href="/hbase/900/" class="nav-link">Hbase</a></li><li class="dropdown-item"><!----> <a href="/hive/1000/" class="nav-link">Hive</a></li><li class="dropdown-item"><!----> <a href="/flume/1100/" class="nav-link">Flume</a></li><li class="dropdown-item"><!----> <a href="/flink/1200/" class="nav-link">Flink</a></li><li class="dropdown-item"><!----> <a href="/mysql/1300/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/mongodb/1800/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><!----> <span class="title" style="display:;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/1900/" class="nav-link">VUE3</a></li><li class="dropdown-item"><!----> <a href="/wx/2000/" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><!----> <span class="title" style="display:;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/2300/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/docker/400/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/jenkins/500/" class="nav-link">Jenkins</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/600/" class="nav-link">Kubernetes</a></li></ul></div></div> <a href="https://github.com/landashu?tab=repositories" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>mysql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/1300/" class="sidebar-link">MySQL 索引介绍</a></li><li><a href="/mysql/1301/" class="sidebar-link">MySQL 锁介绍</a></li><li><a href="/mysql/1302/" class="sidebar-link">MySQL 索引优化工具 explain</a></li><li><a href="/mysql/4/" class="sidebar-link">MySQL 主从复制（GTID）</a></li><li><a href="/mysql/5/" class="sidebar-link">MySQL 8安装</a></li><li><a href="/mysql/6/" class="sidebar-link">MySQL 8.x新特性总结</a></li><li><a href="/mysql/7/" class="sidebar-link">MySQL UDF以及新类型JSON</a></li><li><a href="/mysql/8/" aria-current="page" class="active sidebar-link">MySQL 高可用MGR(一) 理论</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/mysql/8/#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header level2"><a href="/mysql/8/#group-replication原理" class="sidebar-link">Group Replication原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/mysql/8/#_1-单主模式" class="sidebar-link">1 单主模式</a></li><li class="sidebar-sub-header level3"><a href="/mysql/8/#_2-多主模式" class="sidebar-link">2 多主模式</a></li><li class="sidebar-sub-header level3"><a href="/mysql/8/#_3-事物隔离级别补充" class="sidebar-link">3 事物隔离级别补充</a></li><li class="sidebar-sub-header level4"><a href="/mysql/8/#read-committed" class="sidebar-link">Read Committed</a></li><li class="sidebar-sub-header level4"><a href="/mysql/8/#serializable" class="sidebar-link">Serializable</a></li><li class="sidebar-sub-header level4"><a href="/mysql/8/#repeatable-read" class="sidebar-link">Repeatable Read</a></li><li class="sidebar-sub-header level4"><a href="/mysql/8/#read-uncommitted" class="sidebar-link">Read Uncommitted</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/mysql/8/#配置要求和限制" class="sidebar-link">配置要求和限制</a></li><li class="sidebar-sub-header level2"><a href="/mysql/8/#mysql主从可以有多少个" class="sidebar-link">mysql主从可以有多少个</a></li><li class="sidebar-sub-header level2"><a href="/mysql/8/#auto-increment-increment" class="sidebar-link">autoincrementincrement</a></li></ul></li><li><a href="/mysql/9/" class="sidebar-link">MySQL 高可用MGR(二) 搭建</a></li><li><a href="/mysql/10/" class="sidebar-link">MySQL 高可用MGR(三) 测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>mongodb</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mongodb/1800/" class="sidebar-link">mongodb</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="placeholder"></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">MySQL 高可用MGR(一) 理论<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>主从复制，一主多从，主库提供读写功能，从库提供只读功能。当一个事务在 master 提交成功时，会把 binlog 文件同步到从库服务器上落地为 relay log 给 slave 端执行，这个过程主库是不考虑从库是否有接收到 binlog 文件，有可能出现这种情况，当主库 commit 一个事务后，数据库发生宕机，刚好它的 binlog 还没来得及传送到 slave 端，这个时候选任何一个 slave 端都会丢失这个事务，造成数据不一致情况。 为了避免出现主从数据不一致的情况，MySQL 引入了半同步复制，添加多了一个从库反馈机制，即半同步复制。这个有两种方式设置：</p> <ol><li>主库执行完事务后，同步 binlog 给从库，从库 ack 反馈接收到 binlog，主库提交 commit，反馈给客户端，释放会话；</li> <li>主库执行完事务后，主库提交 commit ，同步 binlog 给从库，从库 ack 反馈接收到 binlog，反馈给客户端，释放会话；</li></ol> <p><img src="/assets/img/mysql/8/img.png" alt=""></p> <p>虽然满足了一主多从，读写分析，数据一致，但是，依旧有两个弊端：</p> <ol><li>写操作只能在 master 上；</li> <li>如果 master 宕机，需要人为选择新主并重新给其他的 slave 端执行 change master；</li></ol> <p>为了解决一系列问题，官方推出了 MySQL Group Replication，从 group replication 发布以后，就有 3 种方法来实现 MySQL 的高可用集群：</p> <ul><li>异步复制</li> <li>半同步复制</li> <li>group replication</li></ul> <h2 id="group-replication原理"><a href="#group-replication原理" class="header-anchor">#</a> Group Replication 原理</h2> <p>MySQL Group Replication 有两种模式，单主模式 single-primary mode 和多主模式 multi-primary mode，在同一个 group 内，不允许两种模式同时存在，并且若要切换到不同模式，必须修改配置后重新启动集群。</p> <h3 id="_1-单主模式"><a href="#_1-单主模式" class="header-anchor">#</a> 1 单主模式</h3> <p>在单主模式下，只有一个节点可以读写，其他节点提供只读服务。单主模式下 ，当主节点宕掉，自动会根据服务器的 server_uuid 变量和 group_replication_member_weight 变量值，选择下一个 slave 谁作为主节点，group_replication_member_weight 的值最高的成员被选为新的主节点，该参数默认为 50，建议可以在节点上设置不同值；在 group_replication_member_weight 值相同的情况下，group 根据数据字典中 server_uuid 排序，排序在最前的被选择为主节点。</p> <h3 id="_2-多主模式"><a href="#_2-多主模式" class="header-anchor">#</a> 2 多主模式</h3> <p>在 mysql 多主模式下，在组复制中通过 Group Replication Protocol 协议及 <a href="https://www.cnblogs.com/linbingdong/p/6253479.html" target="_blank" rel="noopener noreferrer">Paxos 协议 (一致性算法)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，形成的整体高可用解决方案，同时增加了 certify (认证) 的概念，负责检查事务是否允许提交，是否与其它事务存在冲突，Group Replication 是由多个节点共同组成一个数据库集群，每个节点都可以单独执行事务，但是 read-write（rw）的操作只有在组内验证后才可以 commit，Read-only (RO) 事务是不需要验证可以立即执行，当一个事务在一个节点上提交之前，会在组内自动进行原子性的广播，告知其他节点变更了什么内容 / 执行了什么事务，然后为该事物建立一个全局的排序，最终，这意味着所有的服务器都以相同的顺序接收相同的事务集。因此，所有服务器都按照相同的顺序应用相同的变更集，因此它们在组中保持一致。 在多主模式下，该组的所有成员都设置为读写模式，在多主模式下，不支持 SERIALIZABLE (严格的) 事务隔离级别，且不能完全支持级联外键约束。</p> <p><img src="/assets/img/mysql/8/img_1.png" alt=""></p> <h3 id="_3-事物隔离级别补充"><a href="#_3-事物隔离级别补充" class="header-anchor">#</a> 3 事物隔离级别补充</h3> <h4 id="read-committed"><a href="#read-committed" class="header-anchor">#</a> Read Committed</h4> <p>在 Read Committed 隔离级别下，一个事务可能会遇到不可重复读（Non Repeatable Read）的问题。不可重复读是指，在一个事务内，多次读同一数据，在这个事务还没有结束时，如果另一个事务恰好修改了这个数据，那么，在第一个事务中，两次读取的数据就可能不一致。<br>
我们先准备好 students 表的数据：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; select * from students;
+----+-------+
| id | name  |
+----+-------+
|  1 | Alice |
+----+-------+
1 row in set (0.00 sec)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后，分别开启两个 MySQL 客户端连接，按顺序依次执行事务 A 和事务 B：</p> <table><thead><tr><th>时刻</th> <th>事务 A</th> <th>事务 B</th></tr></thead> <tbody><tr><td>1</td> <td>SET TRANSACTION ISOLATION LEVEL READ COMMITTED;</td> <td>SET TRANSACTION ISOLATION LEVEL READ COMMITTED;</td></tr> <tr><td>2</td> <td>BEGIN;</td> <td>BEGIN;</td></tr> <tr><td>3</td> <td></td> <td>SELECT * FROM students WHERE id = 1;</td></tr> <tr><td>4</td> <td>UPDATE students SET name = 'Bob' WHERE id = 1;</td> <td></td></tr> <tr><td>5</td> <td>COMMIT;</td> <td></td></tr> <tr><td>6</td> <td></td> <td>SELECT * FROM students WHERE id = 1;</td></tr> <tr><td>7</td> <td></td> <td>COMMIT;</td></tr></tbody></table> <p>当事务 B 第一次执行第 3 步的查询时，得到的结果是 Alice，随后，由于事务 A 在第 4 步更新了这条记录并提交，所以，事务 B 在第 6 步再次执行同样的查询时，得到的结果就变成了 Bob，因此，在 Read Committed 隔离级别下，事务不可重复读同一条记录，因为很可能读到的结果不一致。</p> <h4 id="serializable"><a href="#serializable" class="header-anchor">#</a> Serializable</h4> <p>Serializable 是最严格的隔离级别。在 Serializable 隔离级别下，所有事务按照次序依次执行，因此，脏读、不可重复读、幻读都不会出现。</p> <p>虽然 Serializable 隔离级别下的事务具有最高的安全性，但是，由于事务是串行执行，所以效率会大大下降，应用程序的性能会急剧降低。如果没有特别重要的情景，一般都不会使用 Serializable 隔离级别。</p> <p>默认隔离级别<br>
如果没有指定隔离级别，数据库就会使用默认的隔离级别。在 MySQL 中，如果使用 InnoDB，默认的隔离级别是 Repeatable Read。</p> <h4 id="repeatable-read"><a href="#repeatable-read" class="header-anchor">#</a> Repeatable Read</h4> <p>在 Repeatable Read 隔离级别下，一个事务可能会遇到幻读（Phantom Read）的问题。幻读是指，在一个事务中，第一次查询某条记录，发现没有，但是，当试图更新这条不存在的记录时，竟然能成功，并且，再次读取同一条记录，它就神奇地出现了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; select * from students;
+----+-------+
| id | name  |
+----+-------+
|  1 | Alice |
+----+-------+
1 row in set (0.00 sec)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后，分别开启两个 MySQL 客户端连接，按顺序依次执行事务 A 和事务 B：</p> <table><thead><tr><th>时刻</th> <th>事务 A</th> <th>事务 B</th></tr></thead> <tbody><tr><td>1</td> <td>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;</td> <td>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;</td></tr> <tr><td>2</td> <td>BEGIN;</td> <td>BEGIN;</td></tr> <tr><td>3</td> <td></td> <td>SELECT * FROM students WHERE id = 99;</td></tr> <tr><td>4</td> <td>INSERT INTO students (id, name) VALUES (99, 'Bob');</td> <td></td></tr> <tr><td>5</td> <td>COMMIT;</td> <td></td></tr> <tr><td>6</td> <td></td> <td>SELECT * FROM students WHERE id = 99;</td></tr> <tr><td>7</td> <td></td> <td>UPDATE students SET name = 'Alice' WHERE id = 99;</td></tr> <tr><td>8</td> <td></td> <td>SELECT * FROM students WHERE id = 99;</td></tr> <tr><td>9</td> <td></td> <td>COMMIT;</td></tr></tbody></table> <p>事务 B 在第 3 步第一次读取 id=99 的记录时，读到的记录为空，说明不存在 id=99 的记录。随后，事务 A 在第 4 步插入了一条 id=99 的记录并提交。事务 B 在第 6 步再次读取 id=99 的记录时，读到的记录仍然为空，但是，事务 B 在第 7 步试图更新这条不存在的记录时，竟然成功了，并且，事务 B 在第 8 步再次读取 id=99 的记录时，记录出现了。</p> <p>可见，幻读就是没有读到的记录，以为不存在，但其实是可以更新成功的，并且，更新成功后，再次读取，就出现了。</p> <h4 id="read-uncommitted"><a href="#read-uncommitted" class="header-anchor">#</a> Read Uncommitted</h4> <p>Read Uncommitted 是隔离级别最低的一种事务级别。在这种隔离级别下，一个事务会读到另一个事务更新后但未提交的数据，如果另一个事务回滚，那么当前事务读到的数据就是脏数据，这就是脏读（Dirty Read）。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; select * from students;
+----+-------+
| id | name  |
+----+-------+
|  1 | Alice |
+----+-------+
1 row in set (0.00 sec)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后，分别开启两个 MySQL 客户端连接，按顺序依次执行事务 A 和事务 B：</p> <table><thead><tr><th>时刻</th> <th>事务 A</th> <th>事务 B</th></tr></thead> <tbody><tr><td>1</td> <td>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</td> <td>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</td></tr> <tr><td>2</td> <td>BEGIN;</td> <td>BEGIN;</td></tr> <tr><td>3</td> <td>UPDATE students SET name = 'Bob' WHERE id = 1;</td> <td></td></tr> <tr><td>4</td> <td></td> <td>SELECT * FROM students WHERE id = 1;</td></tr> <tr><td>5</td> <td>ROLLBACK;</td> <td></td></tr> <tr><td>6</td> <td></td> <td>SELECT * FROM students WHERE id = 1;</td></tr> <tr><td>7</td> <td></td> <td>COMMIT;</td></tr></tbody></table> <p>当事务 A 执行完第 3 步时，它更新了 id=1 的记录，但并未提交，而事务 B 在第 4 步读取到的数据就是未提交的数据。随后，事务 A 在第 5 步进行了回滚，事务 B 再次读取 id=1 的记录，发现和上一次读取到的数据不一致，这就是脏读。可见，在 Read Uncommitted 隔离级别下，一个事务可能读取到另一个事务更新但未提交的数据，这个数据有可能是脏数据。</p> <h2 id="配置要求和限制"><a href="#配置要求和限制" class="header-anchor">#</a> 配置<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-requirements.html" target="_blank" rel="noopener noreferrer">要求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-limitations.html" target="_blank" rel="noopener noreferrer">限制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <ul><li>inndb 存储引擎；</li> <li>每个表需要定义显式主键；</li> <li>隔离级别：官网建议 READ COMMITTED 级别，不支持 SERIALIZABLE 隔离级别；</li> <li>不建议使用级联外键；</li> <li>IPv4 网络；</li> <li>auto_increment_increment 和 auto_increment_offset 的配置；</li> <li>log-bin = ROW；</li> <li>log_slave_updates = ON；</li> <li>开启 GTID；</li> <li>安装引擎：group_replication.so；</li></ul> <h2 id="mysql主从可以有多少个"><a href="#mysql主从可以有多少个" class="header-anchor">#</a> mysql 主从可以有多少个</h2> <p>可以成为一个复制组成员的 MySQL 服务器的最大数量为 9。如果其他成员尝试加入该组，则其请求将被拒绝。从测试和基准测试中可以确定此限制是安全的边界，在此范围内，组可以在稳定的局域网上可靠地运行。</p> <h2 id="auto-increment-increment"><a href="#auto-increment-increment" class="header-anchor">#</a> auto_increment_increment</h2> <p>在服务器上启动组复制时，auto_increment_increment 的值将更改为 group_replication_auto_increment_increment 的值（默认值为 7），而 auto_increment_offset 的值将更改为服务器 ID。 停止组复制时，将还原更改。 这些设置避免为组成员上的写入选择重复的自动增量值，这会导致事务回滚。 组复制的默认自动增量值为 7，表示可用值数与复制组的允许最大大小（9 个成员）之间的平衡。</p> <p>仅当 auto_increment_increment 和 auto_increment_offset 各自的默认值均为 1 时，才进行更改并还原。如果已将其值从默认值修改，则组复制不会更改它们。 从 MySQL 8.0 开始，当组复制处于只有一个服务器写入的单主模式下时，系统变量也不会被修改。</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/25/2024, 6:47:14 PM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/mysql/7/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL UDF以及新类型JSON</div></a> <a href="/mysql/9/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MySQL 高可用MGR(二) 搭建</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/mysql/7/" class="prev">MySQL UDF以及新类型JSON</a></span> <span class="next"><a href="/mysql/9/">MySQL 高可用MGR(二) 搭建</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://gitee.com/dashboard" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://github.com/landashu?tab=repositories" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:875730567@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>
<!--      <a href='https://doc.xugaoyi.com/' target='_blank'>Theme by Vdoing</a> | <a href='http://doc.aizuda.com/' rel='external nofollow' target='_blank'>Copyright © 2022-2023 AiZuDa</a>-->
<!--      <br>-->
<!--      <a href="http://beian.miit.gov.cn/" target="_blank">鲁ICP备2021041554号-1</a>-->
    </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.12ef6c1f.js" defer></script><script src="/assets/js/11.5871899e.js" defer></script><script src="/assets/js/98.70766fd8.js" defer></script>
  </body>
</html>
